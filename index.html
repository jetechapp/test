<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0F172A">
    <title>QOTIA V55 - Final Edition</title>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #0F172A;       
            --accent: #F59E0B;        
            --text-main: #1E293B;     
            --text-sub: #64748B;
            --bg-body: #F8FAFC;       
            --border: #E2E8F0;
            --radius: 16px;
            --h-header: 65px;
            --h-nav: 85px;
            --color-devis: #2563EB;
            --color-facture: #D97706;
            --color-cdc: #059669;
            --grad-ia: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg-body); color: var(--text-main); height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* LAYOUT */
        .view-section { 
            display: none; flex-direction: column; height: 100%; width: 100%; 
            position: absolute; top: 0; left: 0; overflow-y: auto; 
            padding-top: var(--h-header); padding-bottom: calc(var(--h-nav) + 20px); 
            background: var(--bg-body); z-index: 10;
        }
        .view-section.active { display: block; z-index: 20; animation: fade 0.2s ease-in; }
        @keyframes fade { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* HEADER */
        .mobile-header { 
            position: fixed; top: 0; left: 0; width: 100%; height: var(--h-header); 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border); display: flex; 
            align-items: center; justify-content: space-between; padding: 0 20px; z-index: 500; 
        }
        .logo-text { font-weight: 800; font-size: 1.3rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .logo-text i { color: var(--accent); }
        .header-btn { font-size: 1.2rem; background: none; border: none; cursor: pointer; color: var(--primary); padding: 8px; }

        /* REFRESH ANIMATION */
        .refreshing { animation: spin 0.8s linear infinite; color: var(--accent) !important; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* HUB BUTTONS */
        .btn-hub { width: 100%; height: 55px; color: white; font-weight: 800; border-radius: 12px; border: none; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 0.9rem; }
        .bg-devis { background-color: var(--color-devis); }
        .bg-facture { background-color: var(--color-facture); }
        .bg-cdc { background-color: var(--color-cdc); }

        /* FOOTER NAV */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--h-nav); 
            background: white; border-top: 1px solid var(--border); 
            display: grid; grid-template-columns: repeat(5, 1fr); z-index: 1000; padding-bottom: 12px;
        }
        .nav-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94A3B8; background: none; border: none; font-size: 0.65rem; font-weight: 700; gap: 4px; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn.active i { color: var(--accent); }

        /* IA BUTTON SPECIAL */
        .ia-btn-container { display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .ia-circle { 
            width: 52px; height: 52px; background: var(--grad-ia); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 1.3rem; color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); 
            margin-top: -25px; border: 4px solid white;
        }

        /* UI ELEMENTS */
        .card-item { background: white; padding: 18px; border-radius: var(--radius); border: 1px solid var(--border); margin: 0 20px 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .app-input { width: 100%; height: 50px; background: white; border: 1px solid var(--border); border-radius: 12px; padding: 0 15px; font-size: 1rem; margin-bottom: 15px; }
        .fab { position: fixed; bottom: 105px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--accent); color: var(--primary); display: flex; align-items: center; justify-content: center; font-size: 1.8rem; box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3); border: 4px solid white; z-index: 900; }
        
        /* MODAL */
        .full-modal { position: fixed; inset: 0; background: var(--bg-body); z-index: 5000; display: none; flex-direction: column; }
        .full-modal.open { display: flex; }
        .modal-header { height: 65px; background: white; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; font-weight: 800; }
        .modal-body { flex: 1; padding: 20px; overflow-y: auto; }
        .btn-primary { width: 100%; height: 55px; background: var(--primary); color: white; font-weight: 800; border-radius: 12px; border: none; }
    </style>
</head>
<body>

    <header class="mobile-header">
        <div class="logo-text"><i class="fas fa-hammer"></i> QOTIA</div>
        <div style="display:flex; gap:5px;">
            <button class="header-btn" onclick="App.refresh()" id="refresh-icon"><i class="fas fa-sync-alt"></i></button>
            <button class="header-btn" onclick="App.toggleMenu()"><i class="fas fa-bars"></i></button>
        </div>
    </header>

    <main id="view-home" class="view-section active">
        <div style="padding: 20px;">
            <div style="margin-top:10px;">
                <div style="color:var(--text-sub); font-size:1.1rem;">Bonjour, Jean</div>
                <div style="font-size: 2.2rem; font-weight: 800; line-height: 1.1;" id="home-date-display">...</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px;">
                <button class="btn-primary" style="height:100px; background:#FFFBEB; color:#D97706; border:1px solid #FCD34D;" onclick="App.nav('projets')">
                    <i class="fas fa-hard-hat" style="font-size:1.5rem;"></i><br>CHANTIERS
                </button>
                <button class="btn-primary" style="height:100px; background:#EFF6FF; color:#2563EB; border:1px solid #93C5FD;" onclick="App.nav('clients')">
                    <i class="fas fa-users" style="font-size:1.5rem;"></i><br>CLIENTS
                </button>
            </div>
        </div>
    </main>

    <main id="view-projets" class="view-section">
        <div style="padding:20px;"><h2 style="margin:0">Mes Chantiers</h2></div>
        <div id="projects-list"></div>
        <button class="fab" onclick="App.openProjectWizard()"><i class="fas fa-plus"></i></button>
    </main>

    <main id="view-hub" class="view-section">
        <div style="padding:20px;">
            <button class="header-btn" onclick="App.nav('projets')" style="margin-bottom:15px; font-size:1rem; padding:0;"><i class="fas fa-arrow-left"></i> Retour</button>
            <h1 id="hub-name" style="margin:0; font-size:1.8rem;">---</h1>
            <p id="hub-client" style="color:var(--text-sub); margin-bottom:30px;">Client...</p>

            <div style="font-weight:800; margin-bottom:10px; font-size:0.8rem; color:var(--text-sub);">ACTIONS PRINCIPALES</div>
            <button class="btn-hub bg-devis" onclick="App.createNewDevis()">
                <i class="fas fa-file-invoice"></i> + NOUVEAU DEVIS
            </button>
            <button class="btn-hub bg-facture" onclick="App.openCreateInvoiceModal()">
                <i class="fas fa-euro-sign"></i> + GÉNÉRER UNE FACTURE
            </button>
            <button class="btn-hub bg-cdc" onclick="alert('Cahier des charges en cours...')">
                <i class="fas fa-clipboard-list"></i> + CAHIER DES CHARGES
            </button>
        </div>
    </main>

    <main id="view-clients" class="view-section">
        <div style="padding:20px;"><h2 style="margin:0">Mes Clients</h2></div>
        <div id="clients-list"></div>
        <button class="fab" onclick="App.openClientModal()"><i class="fas fa-plus"></i></button>
    </main>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="App.nav('home')" id="nav-home">
            <i class="fas fa-th-large"></i><span>Accueil</span>
        </button>
        <button class="nav-btn" onclick="App.nav('projets')" id="nav-projets">
            <i class="fas fa-hard-hat"></i><span>Chantiers</span>
        </button>
        
        <div class="ia-btn-container" onclick="App.openIA()">
            <div class="ia-circle"><i class="fas fa-robot"></i></div>
            <span style="font-size:0.65rem; font-weight:800; color:var(--primary); margin-top:5px;">QOTIA IA</span>
        </div>

        <button class="nav-btn" onclick="App.nav('documents')" id="nav-documents">
            <i class="fas fa-file-invoice"></i><span>Docs</span>
        </button>
        <button class="nav-btn" onclick="App.toggleMenu()">
            <i class="fas fa-cog"></i><span>Menu</span>
        </button>
    </nav>

    <div id="modal-client" class="full-modal">
        <div class="modal-header"><h3>NOUVEAU CLIENT</h3><button class="header-btn" onclick="App.closeModal('modal-client')">×</button></div>
        <div class="modal-body">
            <label>Nom du client</label>
            <input type="text" id="cli-nom" class="app-input" placeholder="ex: Jean Dupont">
            <label>Adresse</label>
            <input type="text" id="cli-addr" class="app-input" placeholder="ex: Paris, France">
            <button class="btn-primary" onclick="App.saveClient()">ENREGISTRER</button>
        </div>
    </div>

    <div id="modal-project" class="full-modal">
        <div class="modal-header"><h3>NOUVEAU CHANTIER</h3><button class="header-btn" onclick="App.closeModal('modal-project')">×</button></div>
        <div class="modal-body">
            <label>Nom du chantier</label>
            <input type="text" id="proj-name" class="app-input" placeholder="ex: Rénovation Salon">
            <label>Client associé</label>
            <select id="proj-client-select" class="app-input"></select>
            <button class="btn-primary" onclick="App.saveProject()">CRÉER LE PROJET</button>
        </div>
    </div>

    <script>
        const Store = {
            data: { clients: [], chantiers: [], appointments: [] },
            init() {
                const s = localStorage.getItem('qotia_v55_final');
                if(s) {
                    this.data = JSON.parse(s);
                } else {
                    this.data.clients = [{id: 1, nom: "Client Démo", addr: "Nice"}];
                    this.save();
                }
            },
            save() { localStorage.setItem('qotia_v55_final', JSON.stringify(this.data)); }
        };

        const App = {
            init() {
                Store.init();
                this.renderHome();
                this.renderProjets();
                this.renderClients();
            },

            // FONCTION REFRESH
            refresh() {
                const icon = document.getElementById('refresh-icon').querySelector('i');
                icon.classList.add('refreshing');
                setTimeout(() => {
                    Store.init();
                    this.renderHome();
                    this.renderProjets();
                    this.renderClients();
                    icon.classList.remove('refreshing');
                }, 700);
            },

            nav(view) {
                document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
                const target = document.getElementById('view-' + view);
                if(target) target.classList.add('active');
                
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                const btn = document.getElementById('nav-' + view);
                if(btn) btn.classList.add('active');
            },

            renderHome() {
                const options = { weekday: 'long', day: 'numeric', month: 'long' };
                document.getElementById('home-date-display').innerText = new Date().toLocaleDateString('fr-FR', options);
            },

            /* CLIENTS */
            renderClients() {
                const list = document.getElementById('clients-list');
                list.innerHTML = Store.data.clients.map(c => `
                    <div class="card-item">
                        <div>
                            <div style="font-weight:800">${c.nom}</div>
                            <div style="font-size:0.8rem; color:var(--text-sub)">${c.addr}</div>
                        </div>
                        <i class="fas fa-user-edit" style="color:var(--border)"></i>
                    </div>
                `).join('') || '<p style="text-align:center; color:var(--text-sub)">Aucun client</p>';
            },

            openClientModal() { document.getElementById('modal-client').classList.add('open'); },
            
            saveClient() {
                const nom = document.getElementById('cli-nom').value;
                const addr = document.getElementById('cli-addr').value;
                if(!nom) return alert("Nom obligatoire");
                Store.data.clients.push({ id: Date.now(), nom, addr });
                Store.save();
                this.closeModal('modal-client');
                this.renderClients();
            },

            /* PROJETS */
            renderProjets() {
                const list = document.getElementById('projects-list');
                list.innerHTML = Store.data.chantiers.map(c => {
                    const client = Store.data.clients.find(cl => cl.id == c.clientId);
                    return `
                        <div class="card-item" onclick="App.openHub(${c.id})">
                            <div>
                                <div style="font-weight:800">${c.name}</div>
                                <div style="font-size:0.8rem; color:var(--text-sub)">${client ? client.nom : 'Sans client'}</div>
                            </div>
                            <i class="fas fa-chevron-right" style="color:var(--accent)"></i>
                        </div>
                    `;
                }).join('') || '<p style="text-align:center; color:var(--text-sub)">Aucun chantier en cours</p>';
            },

            openProjectWizard() {
                if(Store.data.clients.length === 0) return alert("Créez d'abord un client !");
                const sel = document.getElementById('proj-client-select');
                sel.innerHTML = Store.data.clients.map(c => `<option value="${c.id}">${c.nom}</option>`).join('');
                document.getElementById('modal-project').classList.add('open');
            },

            saveProject() {
                const name = document.getElementById('proj-name').value;
                const clientId = document.getElementById('proj-client-select').value;
                if(!name) return alert("Nom obligatoire");
                Store.data.chantiers.push({ id: Date.now(), name, clientId, devis: [], factures: [] });
                Store.save();
                this.closeModal('modal-project');
                this.renderProjets();
            },

            openHub(id) {
                const c = Store.data.chantiers.find(x => x.id == id);
                const cl = Store.data.clients.find(x => x.id == c.clientId);
                document.getElementById('hub-name').innerText = c.name;
                document.getElementById('hub-client').innerText = cl ? "Client : " + cl.nom : "Aucun client";
                this.nav('hub');
            },

            /* IA */
            openIA() {
                alert("QOTIA IA : Analyse de vos données...\nSuggestion : Le chantier '" + 
                (Store.data.chantiers[0]?.name || "Nouveau") + 
                "' nécessite un devis de plomberie selon vos notes.");
            },

            createNewDevis() { alert("Ouverture de l'éditeur de devis..."); },
            openCreateInvoiceModal() { alert("Génération de facture..."); },
            closeModal(id) { document.getElementById(id).classList.remove('open'); },
            toggleMenu() { alert("Paramètres & Export CSV"); }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
