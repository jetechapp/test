<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#F8FAFC">
    <title>QOTIA V54 Masterpiece</title>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            /* --- COLOR PALETTE (HIGH CONTRAST & MODERN) --- */
            --primary: #0F172A;       /* Dark Slate - Professional */
            --accent: #F59E0B;        /* Amber - Focus points */
            --client-color: #2563EB;  /* Blue - Clients */
            --doc-color: #475569;     /* Grey - Docs */
            
            --bg-body: #F1F5F9;       /* Light Grey Background */
            --surface: #FFFFFF;       /* White Surface */
            --border: #E2E8F0;        /* Subtle Borders */
            
            --success: #10B981;
            --danger: #EF4444;

            /* UI METRICS */
            --h-header: 70px;
            --h-nav: 80px;
            --radius-card: 16px;
            --radius-btn: 14px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            margin: 0; padding: 0; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg-body); color: var(--primary); 
            font-size: 15px; height: 100vh; 
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- NAVIGATION LAYOUT --- */
        .view-section { 
            display: none; flex-direction: column; height: 100%; width: 100%; 
            position: absolute; top: 0; left: 0; 
            overflow-y: auto; 
            padding-top: var(--h-header); 
            padding-bottom: calc(var(--h-nav) + 20px); 
            background: var(--bg-body); z-index: 10;
        }
        .view-section.active { display: block; z-index: 20; animation: fadeEntrata 0.25s ease-out; }
        
        @keyframes fadeEntrata { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Specific overrides */
        #view-home { overflow: hidden; padding-bottom: var(--h-nav); } /* Home no scroll */
        #view-editor { padding-top: 0; padding-bottom: 220px; background: white; }

        /* --- HEADER --- */
        .mobile-header { 
            position: fixed; top: 0; left: 0; width: 100%; height: var(--h-header); 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 24px; z-index: 500; 
        }
        .logo-text { font-weight: 900; font-size: 1.4rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .logo-text i { color: var(--accent); font-size: 1.2rem; }
        .app-version { font-size: 0.75rem; font-weight: 700; color: #94A3B8; background: #F8FAFC; padding: 4px 10px; border-radius: 20px; border: 1px solid var(--border); }
        .header-btn { font-size: 1.4rem; color: var(--primary); background: none; border: none; cursor: pointer; }

        /* --- HOME PAGE DESIGN --- */
        .home-container { display: flex; flex-direction: column; height: 100%; padding: 20px 24px; justify-content: flex-start; gap: 20px; }
        
        .welcome-block { margin-top: 10px; }
        .welcome-sub { font-size: 1rem; color: #64748B; font-weight: 500; }
        .welcome-name { font-size: 2rem; font-weight: 800; color: var(--primary); line-height: 1.1; }
        .welcome-date { 
            font-size: 1.1rem; font-weight: 700; color: var(--accent); 
            margin-top: 5px; text-transform: capitalize; 
            background: #FFFBEB; display: inline-block; padding: 4px 12px; border-radius: 8px;
        }

        /* 2 MAIN BUTTONS */
        .action-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .big-btn { 
            height: 130px; border-radius: var(--radius-card); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; position: relative; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.1s;
            border: 1px solid transparent;
        }
        .big-btn:active { transform: scale(0.96); }
        .big-btn i { font-size: 2.4rem; margin-bottom: 12px; }
        .big-btn span { font-weight: 800; font-size: 0.95rem; letter-spacing: 0.5px; text-transform: uppercase; }
        
        .btn-chantier { background: #FFFBEB; border-color: #FCD34D; color: #D97706; }
        .btn-client { background: #EFF6FF; border-color: #93C5FD; color: #2563EB; }

        /* RDV WIDGET */
        .rdv-widget { 
            background: white; border-radius: var(--radius-card); padding: 20px; 
            border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.03); 
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer;
        }
        .rw-content { display: flex; flex-direction: column; gap: 5px; }
        .rw-label { font-size: 0.7rem; font-weight: 800; color: #94A3B8; text-transform: uppercase; letter-spacing: 1px; }
        .rw-title { font-size: 1.1rem; font-weight: 700; color: var(--primary); }
        .rw-time { font-size: 0.95rem; font-weight: 600; color: var(--accent); display: flex; align-items: center; gap: 6px; }
        .rw-badge { background: var(--primary); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; }
        .rw-empty { color: #CBD5E1; font-style: italic; }

        /* KPI BAR (Bottom) */
        .kpi-container { margin-top: auto; padding-bottom: 10px; } /* Pushes to bottom */
        .kpi-bar { 
            background: #FEF2F2; border: 1px solid #FECACA; 
            border-radius: var(--radius-card); padding: 18px 24px; 
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.1);
        }
        .kpi-title { font-weight: 800; color: #B91C1C; font-size: 0.85rem; letter-spacing: 0.5px; text-transform: uppercase; }
        .kpi-val { font-size: 1.4rem; font-weight: 900; color: #B91C1C; }

        /* --- LISTS --- */
        .list-container { padding: 20px; padding-bottom: 100px; }
        .card-item { 
            background: white; padding: 20px; margin-bottom: 15px; 
            border-radius: var(--radius-card); border: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: transform 0.1s;
        }
        .card-item:active { transform: scale(0.99); background: #FAFAFA; }
        
        .card-info { flex: 1; }
        .card-title { font-weight: 700; font-size: 1.05rem; color: var(--primary); margin-bottom: 4px; }
        .card-sub { font-size: 0.9rem; color: #64748B; font-weight: 500; }
        .card-tag { font-size: 0.7rem; font-weight: 700; padding: 3px 8px; border-radius: 6px; background: #F1F5F9; color: #64748B; display: inline-block; margin-bottom: 5px; }
        
        .card-actions { display: flex; gap: 10px; }
        .btn-mini { 
            width: 42px; height: 42px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            border: none; cursor: pointer; font-size: 1.1rem; 
            text-decoration: none;
        }
        .bm-call { background: #ECFDF5; color: var(--success); }
        .bm-map { background: #EFF6FF; color: var(--client-color); }
        .bm-edit { background: #F1F5F9; color: var(--primary); }

        /* --- FAB (FLOATING BUTTON) --- */
        .fab { 
            position: fixed; bottom: 100px; right: 24px; 
            width: 70px; height: 70px; border-radius: 50%; 
            background: var(--accent); color: var(--primary); 
            display: flex; align-items: center; justify-content: center; 
            font-size: 2.2rem; box-shadow: 0 8px 25px rgba(245, 158, 11, 0.5); 
            border: 4px solid white; z-index: 900; cursor: pointer;
            transition: transform 0.2s;
        }
        .fab:active { transform: scale(0.9); }

        /* --- HUB CHANTIER --- */
        .hub-head { padding: 25px 24px; background: white; border-bottom: 1px solid var(--border); }
        .hub-client { font-size: 0.85rem; font-weight: 700; color: #64748B; text-transform: uppercase; letter-spacing: 1px; }
        .hub-name { font-size: 1.8rem; font-weight: 900; color: var(--primary); margin-top: 5px; line-height: 1.2; }
        
        .action-btn { 
            width: 100%; height: 65px; background: white; 
            border: 1px solid var(--border); border-radius: var(--radius-btn); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; font-weight: 700; color: var(--primary); 
            margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); 
        }
        .action-btn i { color: #64748B; font-size: 1.2rem; }
        .action-btn.new-devis { border-left: 5px solid var(--success); }
        .action-btn.new-fac { border-left: 5px solid var(--client-color); }

        /* --- BOTTOM NAV --- */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--h-nav); 
            background: white; border-top: 1px solid var(--border); 
            display: grid; grid-template-columns: repeat(5, 1fr); z-index: 1000; 
            align-items: center; padding-bottom: 10px; 
        }
        .nav-btn { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            color: #94A3B8; background: transparent; border: none; height: 100%; 
            font-size: 0.7rem; font-weight: 700; gap: 5px; cursor: pointer; 
        }
        .nav-btn i { font-size: 1.4rem; transition: transform 0.2s; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn.active i { color: var(--accent); transform: translateY(-2px); }

        /* --- FORM ELEMENTS --- */
        .app-input { 
            width: 100%; height: 60px; background: #F8FAFC; border: 1px solid #CBD5E1; 
            border-radius: var(--radius-btn); padding: 0 20px; font-size: 1.05rem; 
            color: var(--primary); font-weight: 600; outline: none; margin-bottom: 20px; 
            font-family: inherit;
        }
        .app-input:focus { border-color: var(--client-color); background: white; }
        .form-label { display: block; font-size: 0.8rem; font-weight: 700; color: #64748B; margin-bottom: 8px; text-transform: uppercase; }
        
        .btn-primary { 
            width: 100%; height: 60px; background: var(--primary); color: white; 
            font-weight: 800; border-radius: var(--radius-btn); border: none; 
            font-size: 1rem; cursor: pointer; letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(15, 23, 42, 0.3);
        }

        /* --- MODALS --- */
        .full-modal { position: fixed; inset: 0; background: #F8FAFC; z-index: 5000; display: none; flex-direction: column; }
        .full-modal.open { display: flex; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .modal-header { height: 70px; background: white; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; font-weight: 800; font-size: 1.2rem; }
        .modal-body { flex: 1; padding: 24px; overflow-y: auto; }
        .modal-footer { padding: 20px 24px; background: white; border-top: 1px solid var(--border); padding-bottom: 40px; }

        /* --- DOC CHIPS --- */
        .doc-filters { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .doc-chip { 
            font-size: 0.75rem; font-weight: 700; padding: 8px 16px; border-radius: 20px; 
            text-transform: uppercase; white-space: nowrap; cursor: pointer; border: none;
        }
        .dc-all { background: white; border: 1px solid #CBD5E1; color: #64748B; }
        .dc-devis { background: #DBEAFE; color: #1E3A8A; }
        .dc-facture { background: #FEE2E2; color: #991B1B; }
        .dc-etude { background: #D1FAE5; color: #065F46; }

        /* --- EDITOR CARDS --- */
        .e-card { background: white; margin: 0 24px 15px 24px; padding: 20px; border-radius: var(--radius-card); box-shadow: 0 2px 6px rgba(0,0,0,0.03); border-left: 4px solid var(--primary); }
        .e-head { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .e-desc { font-weight: 700; font-size: 1rem; color: var(--primary); width: 85%; }
        .e-idx { font-size: 0.7rem; color: #94A3B8; font-weight: 800; }
        .e-details { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #E2E8F0; }
        .e-val { font-weight: 800; color: var(--primary); font-size: 1.1rem; }
        .e-lbl { font-size: 0.7rem; color: #64748B; font-weight: 700; text-transform: uppercase; }

        /* --- SIDE MENU --- */
        .side-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 5500; display: none; opacity: 0; transition: opacity 0.3s; }
        .side-overlay.open { display: block; opacity: 1; }
        .side-menu { position: fixed; top: 0; right: -300px; width: 280px; height: 100%; background: white; z-index: 6000; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; box-shadow: -10px 0 40px rgba(0,0,0,0.2); }
        .side-menu.open { right: 0; }
        .menu-header { padding: 50px 30px; background: var(--primary); color: white; }
        .menu-item { padding: 20px 30px; border-bottom: 1px solid #F1F5F9; font-weight: 700; color: var(--text-main); display: flex; align-items: center; gap: 15px; cursor: pointer; font-size: 1rem; }

    </style>
</head>
<body>

    <main id="view-home" class="view-section active" style="padding: 0;">
        <header class="mobile-header">
            <div class="logo-text"><i class="fas fa-hammer"></i> QOTIA</div>
            <div class="app-version">v54</div>
            <button class="header-btn" onclick="App.toggleMenu()"><i class="fas fa-bars"></i></button>
        </header>

        <div class="home-container">
            <div>
                <div class="welcome-block">
                    <div class="welcome-sub">Bonjour,</div>
                    <div class="welcome-name">Jean</div>
                    <div class="welcome-date" id="home-date-display">...</div>
                </div>

                <div class="action-grid">
                    <div class="big-btn btn-chantier" onclick="App.nav('projets')">
                        <i class="fas fa-hard-hat"></i>
                        <span>CHANTIERS</span>
                    </div>
                    <div class="big-btn btn-client" onclick="App.nav('clients')">
                        <i class="fas fa-users"></i>
                        <span>CLIENTS</span>
                    </div>
                </div>

                <div class="rdv-widget" onclick="App.openAgenda()">
                    <div class="rw-content">
                        <div class="rw-label">PROCHAIN RENDEZ-VOUS</div>
                        <div class="rw-title" id="home-rdv-title">Chargement...</div>
                        <div class="rw-time" id="home-rdv-time"></div>
                    </div>
                    <div class="rw-right" id="home-rdv-badge"></div>
                </div>
            </div>

            <div class="kpi-container">
                <div class="kpi-bar" onclick="App.nav('factures-global')">
                    <div>
                        <div class="kpi-title">À ENCAISSER</div>
                        <div class="kpi-val" id="home-unpaid">0 €</div>
                    </div>
                    <i class="fas fa-chevron-right" style="color:var(--danger)"></i>
                </div>
            </div>
        </div>
    </main>

    <main id="view-clients" class="view-section">
        <header class="mobile-header"><div class="logo-text">CLIENTS</div></header>
        <div class="list-container">
            <input type="text" class="app-input" placeholder="Rechercher..." onkeyup="App.renderClients(this.value)">
            <div id="clients-list"></div>
        </div>
        <button class="fab" onclick="App.openClientModal()">+</button>
    </main>

    <main id="view-documents" class="view-section">
        <header class="mobile-header"><div class="logo-text">DOCUMENTS</div></header>
        <div class="list-container">
            <div class="doc-filters">
                <button class="doc-chip dc-all" onclick="App.renderDocuments('all')">Tous</button>
                <button class="doc-chip dc-devis" onclick="App.renderDocuments('Devis')">Devis</button>
                <button class="doc-chip dc-facture" onclick="App.renderDocuments('Facture')">Factures</button>
                <button class="doc-chip dc-etude" onclick="App.renderDocuments('Etude')">Etudes</button>
            </div>
            <div id="documents-list"></div>
        </div>
    </main>

    <main id="view-projets" class="view-section">
        <header class="mobile-header"><div class="logo-text">CHANTIERS</div></header>
        <div id="projects-list-full" class="list-container"></div>
        <button class="fab" onclick="App.openProjectWizard()">+</button>
    </main>

    <main id="view-hub" class="view-section">
        <header class="mobile-header">
            <button class="header-btn" onclick="App.nav('projets')"><i class="fas fa-arrow-left"></i></button>
            <div class="logo-text">PROJET</div>
            <div style="width:20px"></div>
        </header>
        <div class="hub-head">
            <div class="hub-client" id="hub-client">-</div>
            <div class="hub-name" id="hub-name">-</div>
        </div>
        <div style="padding:24px;">
            <div class="section-title">DEVIS</div>
            <button class="action-btn new-devis" onclick="App.createNewDevis()"><span>+ Nouveau Devis</span><i class="fas fa-file-contract"></i></button>
            <div id="hub-devis-list"></div>
            
            <div class="section-title" style="margin-top:25px;">FACTURES</div>
            <button class="action-btn new-fac" onclick="App.openCreateInvoiceModal()"><span>+ Nouvelle Facture</span><i class="fas fa-file-invoice-dollar"></i></button>
            <div id="hub-factures-list"></div>

            <div class="section-title" style="margin-top:25px;">DOCUMENTS</div>
            <button class="action-btn" onclick="App.openCreateCDCModal()"><span>+ Cahier Charges</span><i class="fas fa-clipboard-list"></i></button>
            <div id="hub-docs-list"></div>
        </div>
    </main>

    <main id="view-editor" class="view-section">
        <div class="editor-header-wrapper" style="background:white; z-index:400; border-bottom:1px solid #eee;">
            <div class="editor-top-bar" style="display:flex; justify-content:space-between; padding:10px 20px; height:70px; align-items:center;">
                <button class="header-btn" onclick="App.openHub(Store.data.activeChantierId)"><i class="fas fa-arrow-left"></i></button>
                <div style="text-align:right;"><div style="font-size:0.7rem; color:#666;" id="ed-ref">REF</div><div style="font-weight:800; font-size:1.1rem; color:var(--primary);" id="ed-total-header">0 €</div></div>
            </div>
            <div style="padding:0 20px 10px 20px; display:flex; gap:10px;">
                <button id="btn-mode-devis" onclick="App.switchEditorMode('devis')" style="flex:1; height:35px; border-radius:18px; border:1px solid #ddd; background:var(--primary); color:white; font-weight:700;">Devis</button>
                <button id="btn-mode-etude" onclick="App.switchEditorMode('etude')" style="flex:1; height:35px; border-radius:18px; border:1px solid #ddd; background:white; color:#666; font-weight:700;">Tech</button>
            </div>
        </div>
        <div id="editor-list" style="padding-top:140px;"></div>
        <button class="fab" onclick="App.openLibrary()" style="bottom:100px;"><i class="fas fa-plus"></i></button>
    </main>

    <main id="view-factures-global" class="view-section"><header class="mobile-header"><div class="logo-text">FACTURES</div></header><div class="list-container" id="global-invoice-list"></div></main>
    <main id="view-collabs" class="view-section"><header class="mobile-header"><div class="logo-text">EQUIPE</div></header><div class="list-container" id="collabs-list"></div></main>
    <main id="view-settings" class="view-section"><header class="mobile-header"><div class="logo-text">RÉGLAGES</div></header><div style="padding:20px;"><button class="btn-primary" style="background:var(--danger)" onclick="App.hardReset()">RÉINITIALISER APP</button></div></main>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="App.nav('home')" id="nav-home"><i class="fas fa-home"></i><span>Home</span></button>
        <button class="nav-btn" onclick="App.nav('documents')" id="nav-documents"><i class="fas fa-folder"></i><span>Docs</span></button>
        <div class="nav-ai-container"><div class="ai-circle-big" onclick="alert('IA Assistant')">IA</div></div>
        <button class="nav-btn" onclick="App.nav('collabs')" id="nav-collabs"><i class="fas fa-users"></i><span>Equipe</span></button>
        <button class="nav-btn" onclick="App.nav('settings')" id="nav-settings"><i class="fas fa-cog"></i><span>Reglages</span></button>
    </nav>

    <div class="side-overlay" id="side-overlay" onclick="App.toggleMenu()"></div>
    <div class="side-menu" id="side-menu"><div class="menu-header"><div style="font-size:1.6rem; font-weight:800;">MENU</div><div>Collaborateur</div></div><div class="menu-item" onclick="App.nav('settings')">Profil</div><div class="menu-item" onclick="App.hardReset()" style="color:var(--danger)">Reset App</div></div>

    <div id="modal-client" class="full-modal"><div class="modal-header"><h3>Nouveau Client</h3><button class="header-btn" onclick="App.closeModal('modal-client')">×</button></div><div class="modal-body"><input type="hidden" id="cli-id"><input type="text" id="cli-nom" class="app-input" placeholder="Nom Complet"><input type="text" id="cli-addr" class="app-input" placeholder="Adresse"><input type="tel" id="cli-tel" class="app-input" placeholder="Téléphone"><input type="email" id="cli-email" class="app-input" placeholder="Email"></div><div class="modal-footer"><button class="btn-primary" onclick="App.saveClient()">ENREGISTRER</button></div></div>
    
    <div id="modal-projet" class="full-modal"><div class="modal-header"><h3>Nouveau Chantier</h3><button class="header-btn" onclick="App.closeModal('modal-projet')">×</button></div><div class="modal-body"><div style="display:flex;gap:10px;"><select id="prj-cli" class="app-input" style="flex:1"></select><button onclick="App.openClientModal()" style="width:60px;height:60px;background:white;border:1px solid #ddd;border-radius:14px;font-size:1.5rem;">+</button></div><input type="text" id="prj-nom" class="app-input" placeholder="Nom Chantier"><input type="text" id="prj-addr" class="app-input" placeholder="Adresse"><input type="text" id="prj-code" class="app-input" placeholder="Digicode/Infos"></div><div class="modal-footer"><button class="btn-primary" onclick="App.createProject()">CRÉER</button></div></div>

    <div id="modal-agenda" class="full-modal"><div class="modal-header"><h3>Agenda</h3><button class="header-btn" onclick="App.closeModal('modal-agenda')">×</button></div><div class="modal-body"><div id="agenda-today-label" style="text-align:center;margin-bottom:15px;color:var(--accent);font-weight:700;"></div><label class="form-label">Chantier</label><select id="agd-chantier" class="app-input" onchange="App.loadDevisForAgenda()"></select><label class="form-label">Devis (Option)</label><select id="agd-devis" class="app-input"></select><label class="form-label">Date</label><input type="datetime-local" id="agd-date" class="app-input"><div class="section-title">Liste RDV</div><div id="agenda-list-view"></div></div><div class="modal-footer"><button class="btn-primary" onclick="App.saveAgendaEvent()">AJOUTER RDV</button></div></div>

    <div id="modal-invoice" class="full-modal"><div class="modal-header"><h3>Facture</h3><button class="header-btn" onclick="App.closeModal('modal-invoice')">×</button></div><div class="modal-body"><select id="inv-devis-select" class="app-input" onchange="App.onInvoiceDevisChange()"></select><div style="text-align:center;padding:15px;"><div style="font-weight:900;font-size:1.2rem;" id="inv-total-quote">0€</div></div><div style="display:flex;gap:10px;margin-bottom:15px;"><button id="btn-acompte" onclick="App.setInvType('acompte')" style="flex:1;height:45px;border-radius:20px;border:1px solid #ddd;background:var(--primary);color:white;">Acompte %</button><button id="btn-solde" onclick="App.setInvType('solde')" style="flex:1;height:45px;border-radius:20px;border:1px solid #ddd;background:white;">Solde</button></div><input type="number" id="inv-percent" class="app-input" value="30" onchange="App.calcInvPreview()"><div style="text-align:center;font-size:2rem;font-weight:900;" id="inv-preview-amount">0€</div></div><div class="modal-footer"><button class="btn-primary" onclick="App.generateInvoice()">GÉNÉRER</button></div></div>

    <div id="modal-library" class="full-modal"><div class="modal-header"><h3>Bibliothèque</h3><button class="header-btn" onclick="App.closeModal('modal-library')">×</button></div><div class="modal-body" id="lib-container"></div></div>
    <div id="modal-create-cdc" class="full-modal"><div class="modal-header"><h3>Cahier Charges</h3><button class="header-btn" onclick="App.closeModal('modal-create-cdc')">×</button></div><div class="modal-body"><label class="form-label">Devis Source</label><select id="cdc-source-devis" class="app-input"></select><input type="text" id="cdc-name" class="app-input" placeholder="Nom document"></div><div class="modal-footer"><button class="btn-primary" onclick="App.generateCDCFromDevis()">CRÉER</button></div></div>
    <div id="modal-view-cahier" class="full-modal"><div class="modal-header"><h3>Visualisation</h3><button class="header-btn" onclick="App.closeModal('modal-view-cahier')">×</button></div><div class="modal-body"><h4 id="vc-title"></h4><table class="tech-table" id="vc-table"></table></div></div>

    <script>
        const Config = { LIB: { "Démolition": [{desc:"Dépose carrelage", unit:"m²", price:25, time:0.4}], "Peinture": [{desc:"Peinture Mate", unit:"m²", price:18, time:0.4}], "Plomberie": [{desc:"Pose WC", unit:"U", price:450, time:4}] } };
        
        const Store = {
            data: { clients:[], chantiers:[], appointments:[], collaborators:[] },
            init() { 
                const s = localStorage.getItem('qotia_v54_master'); 
                if(s) this.data = JSON.parse(s); else this.seed(); 
            },
            seed() {
                this.data.clients = [{id:1, nom:'Jean Dupont', addr:'Nice', tel:'0600000000'}, {id:2, nom:'Agence Sud', addr:'Cannes'}];
                this.data.chantiers = [{id:1, clientId:1, name:'Rénov Cuisine', ref:'C-01', devisList:[], factures:[], extraDocs:[]}];
                this.data.appointments = [{id:1, date: new Date().toISOString(), title:'RDV Client', sub:'Jean Dupont'}];
                this.save();
            },
            save() { localStorage.setItem('qotia_v54_master', JSON.stringify(this.data)); }
        };

        const App = {
            state: { invType:'acompte' },
            init() { Store.init(); this.nav('home'); },
            
            nav(view) {
                document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
                
                let target = view === 'editor' ? 'editor' : view;
                document.getElementById('view-'+target).classList.add('active');
                if(document.getElementById('nav-'+view)) document.getElementById('nav-'+view).classList.add('active');
                
                if(view==='home') this.renderHome();
                if(view==='clients') this.renderClients();
                if(view==='projets') this.renderProjets();
                if(view==='documents') this.renderDocuments('all');
                if(view==='factures-global') this.renderFacturesGlobal();
                if(view==='collabs') this.renderCollabs();
            },

            // --- HOME ---
            renderHome() {
                // Date
                const d = new Date();
                const dateStr = d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                document.getElementById('home-date-display').innerText = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
                
                // Widget RDV
                const now = new Date();
                const appts = (Store.data.appointments || [])
                    .filter(a => new Date(a.date) > now)
                    .sort((a,b) => new Date(a.date) - new Date(b.date));
                
                if(appts.length > 0) {
                    const next = appts[0];
                    const dateObj = new Date(next.date);
                    document.getElementById('home-rdv-title').innerText = next.title;
                    document.getElementById('home-rdv-time').innerText = `${dateObj.toLocaleDateString()} à ${dateObj.getHours()}:${dateObj.getMinutes().toString().padStart(2,'0')}`;
                    document.getElementById('home-rdv-time').classList.remove('rw-empty');
                    
                    if(appts.length > 1) document.getElementById('home-rdv-badge').innerHTML = `<span class="rw-badge">+${appts.length - 1}</span>`;
                    else document.getElementById('home-rdv-badge').innerHTML = '';
                } else {
                    document.getElementById('home-rdv-title').innerText = "Aucun rendez-vous";
                    document.getElementById('home-rdv-time').innerText = "Rien de prévu";
                    document.getElementById('home-rdv-time').classList.add('rw-empty');
                    document.getElementById('home-rdv-badge').innerHTML = '';
                }

                // KPI
                let unpaid=0; 
                Store.data.chantiers.forEach(c=>{ if(c.factures) c.factures.forEach(f => { if(!f.paid) unpaid += f.amount; }); });
                document.getElementById('home-unpaid').innerText = unpaid.toFixed(0)+" €"; 
            },

            // --- CLIENTS ---
            renderClients(q='') {
                const l = document.getElementById('clients-list'); l.innerHTML = '';
                if(!Store.data.clients) return;
                Store.data.clients.forEach(c => {
                    if(!c.nom) return;
                    if(c.nom.toLowerCase().includes(q.toLowerCase())) {
                        let div = document.createElement('div'); div.className = 'card-item';
                        div.innerHTML = `
                            <div class="card-info" onclick="App.editClient(${c.id})">
                                <div class="card-title">${c.nom}</div>
                                <div class="card-sub">${c.addr || '-'}</div>
                            </div>
                            <div class="card-actions">
                                <a href="tel:${c.tel}" class="btn-mini bm-call"><i class="fas fa-phone"></i></a>
                                <a href="https://maps.google.com/?q=${c.addr}" target="_blank" class="btn-mini bm-map"><i class="fas fa-map-marker-alt"></i></a>
                                <button class="btn-mini bm-edit" onclick="App.editClient(${c.id})"><i class="fas fa-pen"></i></button>
                            </div>
                        `;
                        l.appendChild(div);
                    }
                });
            },
            openClientModal() { ['cli-id','cli-nom','cli-addr','cli-tel','cli-email'].forEach(k=>document.getElementById(k).value=''); document.getElementById('modal-client').classList.add('open'); },
            editClient(id) { const c = Store.data.clients.find(x=>x.id==id); document.getElementById('cli-id').value=c.id; document.getElementById('cli-nom').value=c.nom; document.getElementById('cli-addr').value=c.addr; document.getElementById('cli-tel').value=c.tel; document.getElementById('cli-email').value=c.email; document.getElementById('modal-client').classList.add('open'); },
            saveClient() {
                const id = document.getElementById('cli-id').value;
                const c = { id: id?parseInt(id):Date.now(), nom:document.getElementById('cli-nom').value, addr:document.getElementById('cli-addr').value, tel:document.getElementById('cli-tel').value, email:document.getElementById('cli-email').value };
                if(id) { const idx = Store.data.clients.findIndex(x=>x.id==id); Store.data.clients[idx]=c; } else { Store.data.clients.push(c); }
                Store.save(); App.closeModal('modal-client'); App.renderClients();
                if(document.getElementById('modal-projet').classList.contains('open')) App.updateProjectClientSelect(c.id);
            },

            // --- PROJECTS ---
            renderProjets() {
                const l = document.getElementById('projects-list-full'); l.innerHTML = '';
                Store.data.chantiers.forEach(c => {
                    const cli = Store.data.clients.find(x=>x.id==c.clientId);
                    let div = document.createElement('div'); div.className = 'card-item';
                    div.innerHTML = `<div class="card-info"><div class="card-tag">${c.ref}</div><div class="card-title">${c.name}</div><div class="card-sub">${cli?cli.nom:'-'}</div></div><i class="fas fa-chevron-right" style="color:#ccc"></i>`;
                    div.onclick = () => App.openHub(c.id);
                    l.appendChild(div);
                });
            },
            openProjectWizard() { App.updateProjectClientSelect(); document.getElementById('modal-projet').classList.add('open'); },
            updateProjectClientSelect(sid) { const s = document.getElementById('prj-cli'); s.innerHTML='<option value="">Sélectionner...</option>'; Store.data.clients.forEach(c=>{ let o=document.createElement('option'); o.value=c.id; o.text=c.nom; s.appendChild(o); }); if(sid) s.value=sid; },
            createProject() {
                const cid=document.getElementById('prj-cli').value; const nom=document.getElementById('prj-nom').value;
                if(cid && nom) {
                    const ch = { id:Date.now(), clientId:cid, name:nom, ref:"C-"+Date.now().toString().slice(-4), devisList:[], factures:[], extraDocs:[] };
                    Store.data.chantiers.unshift(ch); Store.save(); App.closeModal('modal-projet'); App.openHub(ch.id);
                }
            },

            // --- HUB ---
            openHub(id) {
                Store.data.activeChantierId = id; Store.save();
                const c = Store.data.chantiers.find(x=>x.id==id);
                const cli = Store.data.clients.find(x=>x.id==c.clientId);
                document.getElementById('hub-name').innerText = c.name;
                document.getElementById('hub-client').innerText = cli ? cli.nom : '-';
                
                // Render Lists
                const ld = document.getElementById('hub-devis-list'); ld.innerHTML=''; 
                c.devisList.forEach(d => { let div = document.createElement('div'); div.className='card-item'; div.innerHTML=`<div class="card-info"><div class="card-title">${d.name}</div><div class="card-sub">${d.total ? d.total.toFixed(0) : 0}€</div></div><i class="fas fa-pen" style="color:#ccc"></i>`; div.onclick=()=>App.openEditor(d.id, 'devis'); ld.appendChild(div); });
                
                const lf = document.getElementById('hub-factures-list'); lf.innerHTML=''; 
                if(c.factures) c.factures.forEach(f => { let div = document.createElement('div'); div.className='card-item'; div.innerHTML=`<div class="card-info"><div class="card-title">${f.ref}</div><div class="card-sub">${f.amount.toFixed(0)}€</div></div>`; lf.appendChild(div); });
                
                const ldoc = document.getElementById('hub-docs-list'); ldoc.innerHTML='';
                if(c.extraDocs) c.extraDocs.forEach(e => { let div = document.createElement('div'); div.className='card-item'; div.innerHTML=`<div class="card-info"><div class="card-title">${e.name}</div><div class="card-sub">CDC</div></div><i class="fas fa-file-alt"></i>`; div.onclick=()=>App.viewCahierTable(e); ldoc.appendChild(div); });
                
                this.nav('hub');
            },

            // --- EDITOR (Simplified) ---
            createNewDevis() { const c = Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId); const newId = Date.now(); c.devisList.push({ id: newId, ref: 'D-'+Math.floor(Math.random()*1000), name: 'Devis #'+(c.devisList.length+1), status: 'Brouillon', items: [], total: 0 }); Store.save(); App.openEditor(newId, 'devis'); },
            openEditor(did, mode) { Store.data.activeDevisId = did; this.nav('editor'); App.renderItems(); },
            renderItems() { 
                const c = Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId); 
                const d = c.devisList.find(x=>x.id==Store.data.activeDevisId);
                const l = document.getElementById('editor-list'); l.innerHTML=''; 
                let tot = 0;
                d.items.forEach(i => {
                   let row = i.qty * i.price; tot += row;
                   let div = document.createElement('div'); div.className = 'e-card';
                   div.innerHTML = `<div class="e-head"><div class="e-desc">${i.desc}</div><div class="e-idx">#</div></div><div class="e-grid" style="display:grid; grid-template-columns:1fr 1fr 1fr; text-align:center;"><div class="e-val">${i.qty}</div><div class="e-val">${i.price}</div><div class="e-val">${row}</div></div>`;
                   l.appendChild(div);
                });
                document.getElementById('ed-total-header').innerText = tot.toFixed(0) + ' €';
            },
            openLibrary() { 
                const c=document.getElementById('lib-container'); c.innerHTML=''; 
                for(let [k,v] of Object.entries(Config.LIB)) { 
                    let h=document.createElement('div'); h.innerHTML=`<b>${k}</b>`; c.appendChild(h); 
                    v.forEach(it=>{ let d=document.createElement('div'); d.className='card-item'; d.innerText=it.desc; d.onclick=()=>{ 
                        const ch=Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId); 
                        const dv=ch.devisList.find(x=>x.id==Store.data.activeDevisId); 
                        dv.items.push({id:Date.now(), ...it, qty:1, price:it.price}); Store.save(); App.closeModal('modal-library'); App.renderItems(); 
                    }; c.appendChild(d); }); 
                } 
                document.getElementById('modal-library').classList.add('open'); 
            },

            // --- DOCS PAGE ---
            renderDocuments(filter) {
                const l = document.getElementById('documents-list'); l.innerHTML = '';
                let docs = [];
                Store.data.chantiers.forEach(c => {
                    const cli = Store.data.clients.find(x=>x.id==c.clientId); const cname = cli ? cli.nom : '-';
                    if(c.devisList) c.devisList.forEach(d => docs.push({type:'Devis', ref:d.ref, name:d.name, client:cname, cid:c.id, obj:d}));
                    if(c.factures) c.factures.forEach(f => docs.push({type:'Facture', ref:f.ref, name:'Facture', client:cname, cid:c.id, obj:f}));
                    if(c.extraDocs) c.extraDocs.forEach(e => docs.push({type:'Etude', ref:e.ref, name:e.name, client:cname, cid:c.id, obj:e}));
                });
                
                if(filter !== 'all') docs = docs.filter(d => d.type === filter);
                
                docs.forEach(d => {
                    let div = document.createElement('div'); div.className = 'card-item';
                    div.innerHTML=`<div class="card-info"><span class="doc-chip">${d.type}</span><div class="card-title">${d.ref}</div><div class="card-sub">${d.client}</div></div><i class="fas fa-chevron-right"></i>`;
                    div.onclick = () => {
                        Store.data.activeChantierId = d.cid;
                        if(d.type === 'Devis') App.openEditor(d.obj.id, 'devis');
                        else if(d.type === 'Facture') App.openHub(d.cid);
                        else App.viewCahierTable(d.obj);
                    };
                    l.appendChild(div);
                });
            },

            // --- AGENDA ---
            openAgenda() {
                const sC = document.getElementById('agd-chantier'); sC.innerHTML='<option value="">Chantier...</option>';
                Store.data.chantiers.forEach(c => { let o = document.createElement('option'); o.value=c.id; o.text=c.name; sC.appendChild(o); });
                document.getElementById('agd-date').value = '';
                document.getElementById('modal-agenda').classList.add('open');
                this.renderAgendaList();
            },
            saveAgendaEvent() {
                const cid = document.getElementById('agd-chantier').value;
                const date = document.getElementById('agd-date').value;
                if(!cid || !date) return alert("Chantier et date requis");
                const c = Store.data.chantiers.find(x=>x.id==cid);
                Store.data.appointments.push({ id: Date.now(), date: date, title: "RDV: "+c.name, sub: "Chantier" });
                Store.save(); this.renderAgendaList(); this.renderHome();
                document.getElementById('agd-date').value = '';
                alert("RDV Ajouté !");
            },
            renderAgendaList() {
                const l = document.getElementById('agenda-list-view'); l.innerHTML = '';
                (Store.data.appointments || []).forEach(a => {
                    let div = document.createElement('div'); div.className='card-item';
                    div.innerHTML = `<div class="card-info"><div class="card-title">${a.title}</div><div class="card-sub">${new Date(a.date).toLocaleString()}</div></div>`;
                    l.appendChild(div);
                });
            },

            // --- INVOICES ---
            openCreateInvoiceModal() { 
                const c = Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId); 
                const s = document.getElementById('inv-devis-select'); s.innerHTML='';
                c.devisList.forEach(d => { let o = document.createElement('option'); o.value=d.id; o.text=d.name + ' ('+d.total+'€)'; s.appendChild(o); });
                document.getElementById('modal-invoice').classList.add('open'); 
            },
            generateInvoice() {
                const c = Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId);
                const did = document.getElementById('inv-devis-select').value;
                const d = c.devisList.find(x=>x.id==did);
                c.factures.push({ id: Date.now(), ref: "FAC-"+Date.now().toString().slice(-4), type: App.state.invType, amount: d.total * 0.3, paid: false });
                Store.save(); App.closeModal('modal-invoice'); App.openHub(c.id);
            },
            renderFacturesGlobal() {
                const l = document.getElementById('global-invoice-list'); l.innerHTML = '';
                Store.data.chantiers.forEach(c => {
                    if(c.factures) c.factures.forEach(f => {
                        let div = document.createElement('div'); div.className = 'card-item';
                        div.innerHTML = `<div class="card-info"><div class="card-title">${f.ref}</div><div class="card-sub">${c.name} - ${f.amount}€</div></div><i class="fas fa-chevron-right"></i>`;
                        div.onclick = () => App.openHub(c.id);
                        l.appendChild(div);
                    });
                });
            },
            renderCollabs() { const l=document.getElementById('collabs-list'); l.innerHTML=''; Store.data.collaborators.forEach(c=>{ let d=document.createElement('div'); d.className='card-item'; d.innerHTML=`<div class="card-info"><div class="card-title">${c.name}</div><div class="card-sub">${c.role}</div></div>`; l.appendChild(d); }); },

            // --- CDC ---
            openCreateCDCModal() { 
                const c = Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId); 
                const s = document.getElementById('cdc-source-devis'); s.innerHTML='';
                c.devisList.forEach(d => { let o = document.createElement('option'); o.value=d.id; o.text=d.name; s.appendChild(o); });
                document.getElementById('modal-create-cdc').classList.add('open'); 
            },
            generateCDCFromDevis() {
                const c = Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId);
                const did = document.getElementById('cdc-source-devis').value;
                const d = c.devisList.find(x=>x.id==did);
                c.extraDocs.push({ id: Date.now(), ref: "CDC-"+Date.now().toString().slice(-4), name: "Cahier "+d.name, type: 'Etude', items: d.items });
                Store.save(); App.closeModal('modal-create-cdc'); App.openHub(c.id);
            },
            viewCahierTable(doc) {
                document.getElementById('vc-title').innerText = doc.name;
                const t = document.getElementById('vc-table'); t.innerHTML = '<tr><th>Item</th><th>Qté</th></tr>';
                doc.items.forEach(i => t.innerHTML += `<tr><td>${i.desc}</td><td>${i.qty}</td></tr>`);
                document.getElementById('modal-view-cahier').classList.add('open');
            },

            // --- UTILS ---
            closeModal(id) { document.getElementById(id).classList.remove('open'); },
            toggleMenu() { document.getElementById('side-menu').classList.toggle('open'); document.getElementById('side-overlay').classList.toggle('open'); },
            hardReset() { if(confirm("Reset?")) { localStorage.clear(); location.reload(); } }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
