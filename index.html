<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#FFFFFF">
    <meta name="description" content="QOTIA Mobile Pro - Gestion BTP">
    <title>QOTIA Mobile Pro</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- DESIGN SYSTEM --- */
        :root {
            --c-yellow: #FCD34D;
            --c-navy: #1E3A8A;
            --c-dark: #111827;
            --c-grey-bg: #FFFFFF;
            --c-grey-light: #F3F4F6;
            --c-border: #E5E7EB;
            --c-danger: #EF4444;
            --c-success: #10B981;
            
            --h-nav: 70px;
            --radius: 4px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; padding: 0; font-family: 'Roboto', sans-serif; 
            background-color: var(--c-grey-bg); color: var(--c-dark);
            font-size: 14px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
        }

        /* --- LAYOUT --- */
        .view-section {
            display: none; flex-direction: column; height: 100%; width: 100%;
            overflow-y: auto; padding-bottom: calc(var(--h-nav) + 20px); background: var(--c-grey-bg);
        }
        .view-section.active { display: flex; }
        #view-devis-editor { padding-bottom: 140px; }

        /* --- HEADER --- */
        .mobile-header {
            flex: 0 0 50px; background: var(--c-grey-bg); border-bottom: 1px solid var(--c-border);
            display: flex; align-items: center; padding: 0 15px; z-index: 100;
        }
        .logo-text { font-weight: 900; font-size: 1.1rem; color: var(--c-navy); display: flex; align-items: center; gap: 8px; }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--h-nav);
            background: var(--c-grey-bg); border-top: 1px solid var(--c-border);
            display: grid; grid-template-columns: repeat(5, 1fr); z-index: 1000; align-items: end; padding-bottom: 5px;
        }
        .nav-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #6B7280; font-size: 0.65rem; border: none; background: transparent; font-weight: 500;
            height: 100%; padding-bottom: 8px; cursor: pointer; text-transform: uppercase;
        }
        .nav-btn i { font-size: 1.2rem; margin-bottom: 4px; }
        .nav-btn.active { color: var(--c-dark); font-weight: 700; }
        
        .nav-btn-ai { position: relative; top: -15px; background: transparent; border: none; cursor: pointer; display: flex; justify-content: center; }
        .ai-circle {
            width: 45px; height: 45px; background: var(--c-yellow); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 2px solid white;
            font-weight: 900; color: var(--c-navy); font-size: 1rem;
        }

        /* --- HOME --- */
        .greeting { font-size: 1.2rem; font-weight: 700; margin: 20px 15px 15px 15px; }
        .top-actions-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 15px; margin-bottom: 25px; }
        .action-box {
            border: 1px solid var(--c-dark); border-radius: 2px; height: 80px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; font-weight: 700; font-size: 0.9rem; background: white; cursor: pointer;
        }
        .section-title { font-size: 0.9rem; font-weight: 700; text-decoration: underline; margin: 0 15px 10px 15px; font-style: italic; }
        .chantier-list-item { border: 1px solid var(--c-dark); padding: 10px; margin: 0 15px 10px 15px; background: white; cursor: pointer; }
        .finance-box {
            border: 1px solid var(--c-danger); padding: 10px 15px; margin: 0 15px;
            display: flex; justify-content: space-between; align-items: center; background: #FEF2F2;
        }

        /* --- EDITOR CONTROLS --- */
        .view-switcher {
            display: grid; grid-template-columns: 1fr 1fr; margin: 10px 15px;
            border: 1px solid var(--c-navy); border-radius: 4px; overflow: hidden;
        }
        .view-btn {
            background: white; color: var(--c-navy); border: none; padding: 8px; font-weight: 700; font-size: 0.8rem; cursor: pointer;
        }
        .view-btn.active { background: var(--c-navy); color: white; }

        .room-scroll-nav {
            flex: 0 0 50px; background: var(--c-navy); display: flex; overflow-x: auto; align-items: center; padding: 0 10px; gap: 8px;
        }
        .room-pill { background: rgba(255,255,255,0.2); color: white; padding: 6px 14px; border-radius: 20px; white-space: nowrap; font-size: 0.9rem; cursor: pointer; }
        .room-pill.active { background: var(--c-yellow); color: var(--c-dark); font-weight: 700; }

        .measures-footer {
            position: fixed; bottom: var(--h-nav); left: 0; width: 100%; height: 60px;
            background: var(--c-dark); display: flex; align-items: center; padding: 5px; gap: 5px;
            z-index: 900; border-top: 3px solid var(--c-yellow);
        }
        .m-inp { width: 100%; background: #374151; border: 1px solid #4B5563; color: white; text-align: center; font-weight: bold; border-radius: 4px; height: 35px; font-size: 1rem; }
        .m-res { color: var(--c-yellow); text-align: center; font-weight: 900; font-size: 1.1rem; line-height: 35px; }

        .ouvr-card {
            border: 1px solid var(--c-border); padding: 10px; margin: 8px 15px; 
            border-left: 4px solid var(--c-yellow); background: white;
            display: flex; justify-content: space-between; align-items: center;
        }
        .cat-header {
            background: #F3F4F6; color: var(--c-navy); font-weight: 700; 
            padding: 8px 15px; margin-top: 15px; text-transform: uppercase; font-size: 0.85rem;
        }

        /* --- MODALS --- */
        .full-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: none; flex-direction: column; overflow-y: auto;
        }
        .full-modal.open { display: flex; }
        .modal-header { flex: 0 0 60px; background: white; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; }
        .app-input { width: 100%; height: 45px; border: 1px solid #111; padding: 0 10px; font-size: 1rem; margin-bottom: 10px; }
        .btn-black { width: 100%; height: 45px; background: #111; color: white; font-weight: 700; border: none; cursor: pointer; }
        .btn-close { font-size: 1.8rem; background: none; border: none; }

        /* AI Overlay */
        .ai-overlay {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white; 
            z-index: 3000; border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 25px; box-shadow: 0 -5px 50px rgba(0,0,0,0.3);
            transform: translateY(100%); transition: transform 0.3s ease;
        }
        .ai-overlay.active { transform: translateY(0); }
        
        /* Banner Mode */
        .mode-banner { padding: 5px; text-align: center; font-weight: bold; font-size: 0.8rem; letter-spacing: 1px; color: white; }
        .mode-banner.devis { background: var(--c-navy); }
        .mode-banner.etude { background: #059669; }

    </style>
</head>
<body>

    <div id="login-view" style="position:fixed; inset:0; background:white; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px;">
        <div style="font-size:2rem; font-weight:900; color:var(--c-navy); margin-bottom:40px;"><i class="fas fa-search" style="color:var(--c-yellow);"></i> QOTIA</div>
        <div style="width:100%; max-width:300px;">
            <h3 style="margin-bottom:20px;">Mon Compte</h3>
            <input type="text" class="app-input" value="Jean" placeholder="Identifiant">
            <input type="password" class="app-input" value="admin" placeholder="Mot de passe">
            <button class="btn-black" onclick="App.login()">Connexion</button>
        </div>
    </div>

    <main id="view-home" class="view-section">
        <header class="mobile-header"><div class="logo-text"><i class="fas fa-search" style="color:var(--c-yellow)"></i> QOTIA</div></header>
        <div class="greeting">Bonjour Jean</div>
        <div class="top-actions-row">
            <div class="action-box" onclick="App.openClientModal()">Nouveau<br>Client</div>
            <div class="action-box" onclick="App.openProjectWizard()">Nouveau<br>Projet</div>
        </div>
        <div class="section-title">Chantiers en cours</div>
        <div id="home-chantier-list"></div>
        <div class="section-title" style="margin-top:20px;">Chiffre d'affaire</div>
        <div class="finance-box"><span style="color:var(--c-danger);font-weight:700;">EN ATTENTE</span><span style="color:var(--c-danger);font-weight:700;" id="home-revenue">0 ‚Ç¨</span></div>
    </main>

    <main id="view-clients" class="view-section">
        <header class="mobile-header"><div class="logo-text">QOTIA</div></header>
        <div style="padding:20px 15px;">
            <h2>Clients</h2><button class="btn-black" style="margin-bottom:20px;" onclick="App.openClientModal()">+ Nouveau Client</button>
            <div id="clients-list-container"></div>
        </div>
    </main>

    <main id="view-projets" class="view-section">
        <header class="mobile-header"><div class="logo-text">QOTIA</div></header>
        <div style="padding:20px 15px;">
            <h2>Projets</h2><button class="btn-black" style="margin-bottom:20px;" onclick="App.openProjectWizard()">+ Nouveau Projet</button>
            <div id="projects-list-full"></div>
        </div>
    </main>

    <main id="view-chantier-detail" class="view-section">
        <header class="mobile-header"><div class="logo-text">QOTIA</div></header>
        <div style="padding:20px 15px; border-bottom:1px solid #eee;">
            <h2 id="detail-proj-name">Projet</h2><div style="color:#666;" id="detail-client-name">Client</div>
        </div>
        <div style="padding:20px 15px;">
            <div class="section-title" style="margin-left:0;">S√©lectionner le mode</div>
            <button class="btn-black" style="margin-bottom:15px; background:var(--c-navy);" onclick="App.goToEditor('devis')">DEVIS (Prix & Vente)</button>
            <button class="btn-black" style="margin-bottom:15px; background:#059669;" onclick="App.goToEditor('etude')">CAHIER DES CHARGES (Tech)</button>
            <div style="font-size:0.75rem; color:#666; font-style:italic;">Le mode "Cahier des charges" permet de saisir les d√©tails techniques sans afficher les prix.</div>
        </div>
    </main>

    <main id="view-devis-editor" class="view-section">
        <div id="mode-banner" class="mode-banner">MODE</div>
        
        <header class="mobile-header" style="height:auto; flex-direction:column; padding:10px 15px; align-items:stretch; border-bottom:none;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <div style="font-weight:900; color:var(--c-navy);" id="editor-proj-name">Projet</div>
                <div style="font-weight:900; color:var(--c-navy);" id="devis-total">0 ‚Ç¨</div>
            </div>
            <div class="view-switcher">
                <button class="view-btn active" id="btn-view-piece" onclick="App.switchView('piece')">PAR PI√àCE</button>
                <button class="view-btn" id="btn-view-ouvrage" onclick="App.switchView('ouvrage')">R√âCAP OUVRAGES</button>
            </div>
        </header>

        <div class="room-scroll-nav" id="room-tabs"></div>

        <div id="devis-items-list" style="padding:10px 0;"></div>

        <button style="position:fixed; bottom:140px; right:20px; width:50px; height:50px; background:var(--c-navy); color:white; border-radius:50%; border:none; font-size:1.5rem; box-shadow:0 4px 10px rgba(0,0,0,0.2); z-index:950;" onclick="App.openLibrary()">+</button>

        <div class="measures-footer">
            <div class="m-box"><label>Long</label><input type="number" class="m-inp" id="m-L" onchange="App.calcMetrics()"></div>
            <div class="m-box"><label>Larg</label><input type="number" class="m-inp" id="m-l" onchange="App.calcMetrics()"></div>
            <div class="m-box"><label>Haut</label><input type="number" class="m-inp" id="m-h" value="2.70" onchange="App.calcMetrics()"></div>
            <div class="m-box" style="flex:0.8;"><label>M¬≤</label><div class="m-res" id="m-surf">0</div></div>
        </div>
    </main>

    <main id="view-account" class="view-section">
        <header class="mobile-header"><div class="logo-text">QOTIA</div></header>
        <div style="padding:20px 15px;">
            <h2>Mon Compte</h2>
            <ul style="list-style:none; padding:0; margin-top:20px;">
                <li style="padding:15px 0; border-bottom:1px solid #eee;">Infos Soci√©t√©</li>
                <li style="padding:15px 0; border-bottom:1px solid #eee;">Abonnement</li>
            </ul>
            <button class="btn-black" onclick="location.reload()" style="margin-top:30px;">D√©connexion</button>
        </div>
    </main>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="App.nav('home')" id="nav-home"><i class="fas fa-home"></i> HOME</button>
        <button class="nav-btn" onclick="App.nav('clients')" id="nav-clients"><i class="fas fa-users"></i> CLIENTS</button>
        <button class="nav-btn-ai" onclick="AI.openPrompt()"><div class="ai-circle">IA</div><span>ASSIST</span></button>
        <button class="nav-btn" onclick="App.nav('projets')" id="nav-projets"><i class="fas fa-folder"></i> PROJETS</button>
        <button class="nav-btn" onclick="App.nav('account')" id="nav-account"><i class="fas fa-user"></i> COMPTE</button>
    </nav>

    <div id="ai-overlay" class="ai-overlay">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3 style="margin:0; color:var(--c-navy);">Assistant IA</h3>
            <button onclick="AI.close()" style="border:none; background:none; font-size:1.5rem;">&times;</button>
        </div>
        <textarea id="ai-input" class="app-input" style="height:100px;" placeholder="Ex: Cr√©er projet... ou Ajouter Peinture 40m2..."></textarea>
        <button class="btn-black" onclick="AI.process()">Ex√©cuter</button>
    </div>

    <div id="modal-client" class="full-modal">
        <div class="modal-header"><h3>Nouveau Client</h3><button class="btn-close" onclick="App.closeModal('modal-client')">&times;</button></div>
        <div class="modal-body" style="padding:20px;">
            <input type="text" id="cli-nom" class="app-input" placeholder="Nom / Soci√©t√©">
            <input type="text" id="cli-addr" class="app-input" placeholder="Adresse">
            <input type="text" id="cli-phone" class="app-input" placeholder="T√©l√©phone">
            <button class="btn-black" onclick="App.saveClient()">Enregistrer</button>
        </div>
    </div>

    <div id="modal-chantier" class="full-modal">
        <div class="modal-header"><h3>Nouveau projet</h3><button class="btn-close" onclick="App.closeModal('modal-chantier')">&times;</button></div>
        <div class="modal-body" style="padding:20px;">
            <select id="proj-client-select" class="app-input"><option>Client</option></select>
            <input type="text" id="proj-name" class="app-input" placeholder="Nom Projet">
            <input type="text" id="proj-code" class="app-input" placeholder="Digicode">
            <button class="btn-black" onclick="App.createChantier()">Cr√©er</button>
        </div>
    </div>

    <div id="modal-library" class="full-modal">
        <div class="modal-header"><h3>Biblioth√®que</h3><button class="btn-close" onclick="App.closeModal('modal-library')">&times;</button></div>
        <div class="modal-body" id="lib-container" style="padding:0;"></div>
    </div>

    <script>
        const Store = {
            data: { clients: [], chantiers: [], activeChantierId: null },
            init() { 
                const s = localStorage.getItem('qotia_v5_final'); 
                if(s) this.data = JSON.parse(s);
                else {
                    this.data.clients = [{id:1, nom:"Bernard Durant", addr:"Paris"}];
                    this.data.chantiers = [{id:101, clientId:1, name:"Renovation SDB", ref:"Devis 2026-009", activeRoom:'SDB', rooms:['SDB'], metrics:{'SDB':{L:0,l:0,h:2.5}}, items:[], total:0}];
                }
            },
            save() { localStorage.setItem('qotia_v5_final', JSON.stringify(this.data)); }
        };

        const Config = { LIBRARY: { 'Gros Oeuvre': ['D√©molition','Evacuation'], 'Second Oeuvre': ['Pl√¢trerie','Peinture','Carrelage'], 'Tech': ['Plomberie','Electricit√©'] } };

        const App = {
            currentMode: 'devis', // 'devis' or 'etude' (cahier de charge)
            currentView: 'piece', // 'piece' or 'ouvrage'

            init() {
                Store.init();
                if(localStorage.getItem('qotia_logged')) document.getElementById('login-view').style.display='none';
                this.renderHome();
                this.updateRevenue();
            },
            login() { localStorage.setItem('qotia_logged','true'); document.getElementById('login-view').style.display='none'; },
            
            nav(view) {
                document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
                document.getElementById('view-'+(view=='devis-editor'?'devis-editor':view)).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
                if(document.getElementById('nav-'+view)) document.getElementById('nav-'+view).classList.add('active');
                if(view==='home') { this.renderHome(); this.updateRevenue(); }
                if(view==='clients') this.renderClients();
                if(view==='projets') this.renderProjectsList();
            },

            // LOGIC FOR EDITOR MODE & VIEW
            openIntermediatePage(id) {
                Store.data.activeChantierId = id; Store.save();
                const c = Store.data.chantiers.find(x=>x.id==id);
                const cli = Store.data.clients.find(x=>x.id==c.clientId);
                document.getElementById('detail-proj-name').innerText=c.name;
                document.getElementById('detail-client-name').innerText=cli?cli.nom:'';
                this.nav('chantier-detail');
            },
            goToEditor(mode) {
                this.currentMode = mode;
                const banner = document.getElementById('mode-banner');
                banner.innerText = mode === 'devis' ? "MODE DEVIS (PRIX AFFICH√âS)" : "MODE CAHIER DES CHARGES (TECHNIQUE)";
                banner.className = `mode-banner ${mode}`;
                
                // Reset view to piece by default
                this.switchView('piece');
                this.nav('devis-editor');
            },
            switchView(view) {
                this.currentView = view;
                document.getElementById('btn-view-piece').className = `view-btn ${view=='piece'?'active':''}`;
                document.getElementById('btn-view-ouvrage').className = `view-btn ${view=='ouvrage'?'active':''}`;
                
                // Toggle Room Tabs visibility
                document.getElementById('room-tabs').style.display = view === 'piece' ? 'flex' : 'none';
                this.renderEditor();
            },

            renderEditor() {
                const c = Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId);
                document.getElementById('editor-proj-name').innerText = c.name;
                
                // Render Rooms only if in Piece view
                if(this.currentView === 'piece') {
                    const tabs = document.getElementById('room-tabs'); tabs.innerHTML='';
                    c.rooms.forEach(r=>{
                        const p=document.createElement('div'); p.className=`room-pill ${r===c.activeRoom?'active':''}`; p.innerText=r;
                        p.onclick=()=>{c.activeRoom=r; Store.save(); App.renderEditor();}; tabs.appendChild(p);
                    });
                    const add=document.createElement('div'); add.className='room-pill'; add.innerText='+';
                    add.onclick=()=>{const n=prompt('Nom pi√®ce?'); if(n){c.rooms.push(n);c.metrics[n]={L:0,l:0,h:2.5};c.activeRoom=n;Store.save();App.renderEditor();}}; tabs.appendChild(add);
                    
                    // Metrics
                    const m=c.metrics[c.activeRoom]||{L:0,l:0,h:2.5};
                    document.getElementById('m-L').value=m.L; document.getElementById('m-l').value=m.l; document.getElementById('m-h').value=m.h;
                    this.calcMetrics(false);
                }

                const list = document.getElementById('devis-items-list'); list.innerHTML='';
                let itemsToShow = [];

                if(this.currentView === 'piece') {
                    // Filter by Active Room
                    itemsToShow = c.items.filter(i => i.room === c.activeRoom);
                } else {
                    // AGGREGATE VIEW (Ouvrages)
                    // We sum quantities for same description
                    const agg = {};
                    c.items.forEach(i => {
                        if(!agg[i.desc]) agg[i.desc] = { ...i, qty:0, rooms:[] };
                        agg[i.desc].qty += i.qty;
                        if(!agg[i.desc].rooms.includes(i.room)) agg[i.desc].rooms.push(i.room);
                    });
                    itemsToShow = Object.values(agg);
                }

                if(itemsToShow.length === 0) list.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Aucun ouvrage.</div>';

                itemsToShow.forEach(i => {
                    const d = document.createElement('div');
                    d.className = 'ouvr-card';
                    
                    // Logic Display based on Mode (Devis vs Etude)
                    let rightSide = '';
                    if(this.currentMode === 'devis') {
                        rightSide = `<b>${(i.qty*i.price).toFixed(0)} ‚Ç¨</b>`;
                    } else {
                        // Etude Mode: Show Tech info (e.g. Temps, Unit) instead of Price
                        rightSide = `<span style="color:#059669; font-size:0.8rem;">${i.unit} (Tech)</span>`;
                    }

                    // Rooms badge for Ouvrage View
                    let roomBadge = this.currentView === 'ouvrage' ? `<div style="font-size:0.7rem; color:var(--c-navy); margin-top:2px;">üìç ${i.rooms ? i.rooms.join(', ') : i.room}</div>` : '';

                    d.innerHTML = `
                        <div>
                            <b>${i.desc}</b>
                            ${roomBadge}
                            <div style="font-size:0.8rem; color:#666;">${i.qty.toFixed(1)} ${i.unit} ${this.currentMode=='devis' ? 'x '+i.price+'‚Ç¨' : ''}</div>
                        </div>
                        ${rightSide}
                    `;
                    list.appendChild(d);
                });

                // Update Total (Always visible but maybe distinct)
                let tot = c.items.reduce((a,b)=>a+(b.qty*b.price),0);
                document.getElementById('devis-total').innerText = tot.toFixed(0) + ' ‚Ç¨';
                c.total = tot; Store.save();
            },

            calcMetrics(save=true){
                const L=parseFloat(document.getElementById('m-L').value)||0; const l=parseFloat(document.getElementById('m-l').value)||0; const h=parseFloat(document.getElementById('m-h').value)||0;
                document.getElementById('m-surf').innerText=(L*l).toFixed(2);
                if(save){const c=Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId); c.metrics[c.activeRoom]={L,l,h}; Store.save();}
            },

            // LIST RENDERERS
            renderHome() {
                const list = document.getElementById('home-chantier-list'); list.innerHTML='';
                Store.data.chantiers.forEach(c=>{
                    const cli=Store.data.clients.find(x=>x.id==c.clientId);
                    const d=document.createElement('div'); d.className='chantier-list-item';
                    d.innerHTML=`<div style="font-weight:700">${c.ref}</div><div>${cli?cli.nom:'?'} : ${c.name}</div>`;
                    d.onclick=()=>App.openIntermediatePage(c.id); list.appendChild(d);
                });
            },
            updateRevenue(){
                let t = Store.data.chantiers.reduce((a,c)=>a+(c.total||0),0);
                document.getElementById('home-revenue').innerText=t.toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
            },
            renderClients(){
                const l=document.getElementById('clients-list-container');l.innerHTML='';
                Store.data.clients.forEach(c=>{
                    const d=document.createElement('div'); d.className='chantier-list-item'; d.innerText=c.nom; l.appendChild(d);
                });
            },
            renderProjectsList(){
                const l=document.getElementById('projects-list-full');l.innerHTML='';
                Store.data.chantiers.forEach(c=>{
                    const d=document.createElement('div'); d.className='chantier-list-item'; d.innerText=c.name; d.onclick=()=>App.openIntermediatePage(c.id); l.appendChild(d);
                });
            },

            // MODALS & HELPERS
            openClientModal(){document.getElementById('modal-client').classList.add('open');},
            openProjectWizard(){
                const s=document.getElementById('proj-client-select');s.innerHTML='<option>Client</option>';
                Store.data.clients.forEach(c=>{let o=document.createElement('option');o.value=c.id;o.innerText=c.nom;s.appendChild(o)});
                document.getElementById('modal-chantier').classList.add('open');
            },
            openLibrary(){
                const c=document.getElementById('lib-container');c.innerHTML='';
                for(const [k,v] of Object.entries(Config.LIBRARY)){
                    let h=document.createElement('div');h.style='padding:10px;background:#eee;font-weight:bold';h.innerText=k;c.appendChild(h);
                    v.forEach(it=>{
                        let d=document.createElement('div');d.style='padding:15px;border-bottom:1px solid #ddd';d.innerText=it;
                        d.onclick=()=>{
                            const ch=Store.data.chantiers.find(x=>x.id==Store.data.activeChantierId);
                            // Auto calc qty
                            const m=ch.metrics[ch.activeRoom]; let q=1;
                            if(['Peinture','Carrelage','Pl√¢trerie'].includes(k)) q=m.L*m.l;
                            ch.items.push({id:Date.now(),room:ch.activeRoom,desc:it,qty:parseFloat(q.toFixed(2)),unit:'m¬≤',price:50});
                            Store.save(); App.closeModal('modal-library'); App.renderEditor();
                        }; c.appendChild(d);
                    });
                }
                document.getElementById('modal-library').classList.add('open');
            },
            closeModal(id){document.getElementById(id).classList.remove('open');},
            saveClient(){
                const n=document.getElementById('cli-nom').value;
                if(n){Store.data.clients.push({id:Date.now(),nom:n,addr:document.getElementById('cli-addr').value});Store.save();App.closeModal('modal-client');App.renderHome();}
            },
            createChantier(){
                const cid=document.getElementById('proj-client-select').value; const nom=document.getElementById('proj-name').value;
                if(cid&&nom){
                    Store.data.chantiers.unshift({id:Date.now(),clientId:cid,name:nom,ref:"Devis "+new Date().getFullYear(),activeRoom:'SDB',rooms:['SDB'],metrics:{'SDB':{L:0,l:0,h:2.5}},items:[],total:0});
                    Store.save(); App.closeModal('modal-chantier'); App.renderHome();
                }
            }
        };

        const AI = {
            openPrompt() { document.getElementById('ai-overlay').classList.add('active'); },
            close() { document.getElementById('ai-overlay').classList.remove('active'); },
            process() {
                const txt = document.getElementById('ai-input').value.toLowerCase();
                AI.close();
                if(txt.includes('projet') || txt.includes('chantier')) {
                    alert("IA: Cr√©ation Projet d√©tect√©e...");
                    // Mock creation
                    Store.data.chantiers.unshift({id:Date.now(),clientId:Store.data.clients[0].id,name:"Projet IA",ref:"Auto",activeRoom:'Main',rooms:['Main'],metrics:{'Main':{L:4,l:3,h:2.5}},items:[],total:0});
                    Store.save(); App.renderHome();
                } else {
                    alert("IA: Ajout Ouvrages d√©tect√©...");
                }
            }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
