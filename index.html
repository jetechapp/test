<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="QOTIA Mobile Pro - Gestion BTP">
    <title>QOTIA | Gestion Chantier Mobile</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- SYSTEM DESIGN "RUGGED" (Cantiere) --- */
        :root {
            --c-yellow: #FCD34D;     /* Brand Primary */
            --c-yellow-dark: #F59E0B;
            --c-navy: #1E3A8A;       /* Brand Accent */
            --c-dark: #111827;       /* Testo Nero/Scuro */
            --c-grey: #F3F4F6;       /* Sfondo */
            --c-white: #FFFFFF;
            --c-danger: #EF4444;
            --c-success: #10B981;
            
            --h-nav: 65px;           /* Altezza Navigazione */
            --h-input: 50px;         /* Altezza Input Touch */
            --radius: 8px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; padding: 0; 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--c-grey); 
            color: var(--c-dark);
            font-size: 16px; 
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* --- LAYOUT MANAGERS --- */
        .view-section {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            overflow-y: auto;
            padding-bottom: calc(var(--h-nav) + 20px);
            background: var(--c-grey);
        }
        .view-section.active { display: flex; }
        
        /* Padding extra per l'editor che ha il footer misure */
        #view-devis { padding-bottom: 140px; }

        /* --- TYPOGRAPHY & UTILS --- */
        h1, h2, h3 { margin: 0; font-weight: 800; letter-spacing: -0.5px; }
        .text-navy { color: var(--c-navy); }
        .text-muted { color: #6B7280; font-size: 0.9rem; }
        .full-width { width: 100%; }
        .mt-2 { margin-top: 10px; }
        .mb-2 { margin-bottom: 10px; }

        /* --- HEADER & NAV --- */
        .mobile-header {
            flex: 0 0 60px;
            background: var(--c-white);
            border-bottom: 2px solid var(--c-yellow);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--h-nav);
            background: var(--c-white); border-top: 1px solid #E5E7EB;
            display: grid; grid-template-columns: repeat(4, 1fr);
            z-index: 1000;
        }
        .nav-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #9CA3AF; font-size: 0.7rem; border: none; background: transparent; font-weight: 600;
        }
        .nav-btn i { font-size: 1.4rem; margin-bottom: 4px; }
        .nav-btn.active { color: var(--c-navy); background: #EFF6FF; }

        /* --- CARDS & LISTS --- */
        .card {
            background: var(--c-white);
            border-radius: var(--radius);
            padding: 15px; margin: 10px 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid var(--c-navy);
        }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px 15px; }
        .big-btn {
            background: var(--c-white); border: 2px solid #E5E7EB;
            border-radius: var(--radius); padding: 20px 10px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: 700; color: var(--c-navy); transition: all 0.1s;
        }
        .big-btn:active { background: #EFF6FF; border-color: var(--c-navy); }
        .big-btn i { font-size: 2rem; margin-bottom: 10px; color: var(--c-yellow-dark); }

        /* --- FORMS --- */
        .form-section-title {
            background: #E5E7EB; padding: 8px 15px; 
            font-weight: 700; color: var(--c-navy); font-size: 0.9rem;
            margin-top: 15px; margin-bottom: 10px;
        }
        .input-group { margin-bottom: 12px; padding: 0 15px; }
        .input-label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--c-navy); margin-bottom: 4px; text-transform: uppercase; }
        .app-input {
            width: 100%; height: var(--h-input);
            border: 1px solid #D1D5DB; border-radius: 6px;
            padding: 0 10px; font-size: 1rem; background: #fff;
        }
        .app-input:focus { border-color: var(--c-navy); border-width: 2px; }
        
        /* Switch Client Type */
        .type-switch { display: flex; margin: 0 15px; background: #E5E7EB; border-radius: 8px; padding: 4px; }
        .switch-opt { flex: 1; text-align: center; padding: 8px; font-weight: 600; border-radius: 6px; font-size: 0.9rem; color: #666; }
        .switch-opt.active { background: white; color: var(--c-navy); shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* --- DEVIS EDITOR (Sticky & Tabs) --- */
        .room-scroll-nav {
            flex: 0 0 50px; background: var(--c-navy);
            display: flex; overflow-x: auto; align-items: center;
            padding: 0 10px; gap: 8px;
        }
        .room-pill {
            background: rgba(255,255,255,0.2); color: white;
            padding: 6px 14px; border-radius: 20px; white-space: nowrap; font-size: 0.9rem;
        }
        .room-pill.active { background: var(--c-yellow); color: var(--c-dark); font-weight: 700; }
        
        /* Sticky Measures Footer */
        .measures-footer {
            position: fixed; bottom: var(--h-nav); left: 0; width: 100%;
            height: 60px; background: var(--c-dark);
            display: flex; align-items: center; padding: 5px; gap: 5px;
            z-index: 900; border-top: 3px solid var(--c-yellow);
        }
        .m-box { flex: 1; display: flex; flex-direction: column; }
        .m-box label { color: #9CA3AF; font-size: 0.6rem; text-align: center; text-transform: uppercase; }
        .m-inp { 
            width: 100%; background: #374151; border: 1px solid #4B5563; 
            color: white; text-align: center; font-weight: bold; border-radius: 4px; 
            height: 35px; font-size: 1rem;
        }
        .m-res { color: var(--c-yellow); text-align: center; font-weight: 900; font-size: 1.1rem; line-height: 35px; }

        /* FAB Add Button */
        .fab-add {
            position: fixed; bottom: calc(var(--h-nav) + 75px); right: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            background: var(--c-navy); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 950; border: 2px solid white;
        }

        /* --- MODALS (Full Screen for Rugged use) --- */
        .full-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--c-grey); z-index: 2000;
            display: none; flex-direction: column;
            overflow-y: auto;
        }
        .full-modal.open { display: flex; }
        .modal-header {
            flex: 0 0 60px; background: white; border-bottom: 1px solid #ddd;
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
        }
        .btn-close { font-size: 1.5rem; background: none; border: none; color: #666; }
        .modal-body { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        
        .btn-save {
            width: 100%; height: 50px; background: var(--c-navy); color: white;
            font-weight: 700; border: none; font-size: 1rem;
        }

        /* Items in Devis */
        .ouvr-card {
            background: white; padding: 12px; margin: 8px 10px; border-radius: 8px;
            border: 1px solid #E5E7EB; border-left: 4px solid var(--c-yellow);
            display: flex; justify-content: space-between; align-items: center;
        }
        .ouvr-fam { font-size: 0.7rem; color: var(--c-navy); font-weight: 700; text-transform: uppercase; }
        .ouvr-desc { font-weight: 600; margin: 2px 0; color: #374151; }
        .ouvr-meta { font-size: 0.85rem; color: #6B7280; }
        .ouvr-price { font-weight: 800; font-size: 1.1rem; color: var(--c-dark); }

    </style>
</head>
<body>

    <div id="login-view" style="position:fixed; inset:0; background:var(--c-navy); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px;">
        <div style="width: 80px; height: 80px; background: var(--c-yellow); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: 900; color: var(--c-navy); margin-bottom: 20px;">Q</div>
        <h1 style="color:white; margin-bottom: 10px;">QOTIA Mobile</h1>
        <div style="color:#CBD5E1; margin-bottom: 40px;">Pour le COLLABORATEUR</div>
        <div style="background:white; padding:20px; border-radius:12px; width:100%; max-width:350px;">
            <input type="text" class="app-input mb-2" value="admin" placeholder="Identifiant">
            <input type="password" class="app-input mb-2" value="admin" placeholder="Mot de passe">
            <button class="btn-save" style="border-radius:6px;" onclick="App.login()">CONNEXION</button>
        </div>
    </div>

    <main id="view-home" class="view-section">
        <header class="mobile-header">
            <div style="font-weight:900; font-size:1.2rem; color:var(--c-navy);"><i class="fas fa-hammer text-yellow"></i> QOTIA</div>
            <div style="font-size:0.8rem; font-weight:bold;">Bienvenue</div>
        </header>

        <div class="action-grid">
            <div class="big-btn" onclick="App.openProjectWizard()">
                <i class="fas fa-folder-plus"></i>
                <span>Nouveau<br>Chantier</span>
            </div>
            <div class="big-btn" onclick="App.openClientModal()">
                <i class="fas fa-user-plus"></i>
                <span>Nouveau<br>Client</span>
            </div>
        </div>

        <div style="padding: 0 15px;">
            <div class="card" style="margin: 0 0 15px 0; background:#FFFBEB; border-color:var(--c-yellow);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-size:0.75rem; text-transform:uppercase; color:#92400E; font-weight:700;">CA Accepté (Mois)</div>
                        <div style="font-size:1.8rem; font-weight:900; color:#B45309;" id="kpi-revenue">0 €</div>
                    </div>
                    <i class="fas fa-chart-line" style="font-size:2rem; color:#FCD34D;"></i>
                </div>
            </div>

            <h3 style="margin: 10px 0; color:var(--c-navy);">Devis Récents</h3>
            <div id="home-recent-list">
                </div>
        </div>
    </main>

    <main id="view-clients" class="view-section">
        <header class="mobile-header">
            <h3>Fichier Clients</h3>
            <button onclick="App.openClientModal()" style="border:none; background:none; font-size:1.5rem; color:var(--c-navy);"><i class="fas fa-plus-circle"></i></button>
        </header>
        <div style="padding:10px 15px; background:white; border-bottom:1px solid #eee;">
            <input type="text" class="app-input" placeholder="Rechercher..." onkeyup="App.renderClients(this.value)">
        </div>
        <div id="clients-list-container"></div>
    </main>

    <main id="view-devis" class="view-section">
        <header class="mobile-header" style="height:auto; flex-direction:column; padding:10px 15px; align-items:stretch;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <div style="overflow:hidden;">
                    <div style="font-weight:900; font-size:1.1rem; color:var(--c-navy); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" id="devis-client-name">Client...</div>
                    <div style="font-size:0.8rem; color:#666;" id="devis-chantier-name">Chantier...</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:900; font-size:1.2rem; color:var(--c-navy);" id="devis-total">0 €</div>
                    <button onclick="App.openChantierDetails()" style="font-size:0.7rem; background:#EFF6FF; border:1px solid #DBEAFE; border-radius:4px; padding:2px 6px; color:var(--c-navy); font-weight:700;">Info Chantier</button>
                </div>
            </div>
        </header>

        <div class="room-scroll-nav" id="room-tabs"></div>

        <div id="devis-items-list" style="padding:10px 0;"></div>

        <button class="fab-add" onclick="App.openLibrary()"><i class="fas fa-plus"></i></button>

        <div class="measures-footer">
            <div class="m-box"><label>Long(m)</label><input type="number" class="m-inp" id="m-L" onchange="App.calcMetrics()"></div>
            <div class="m-box"><label>Larg(m)</label><input type="number" class="m-inp" id="m-l" onchange="App.calcMetrics()"></div>
            <div class="m-box"><label>Haut(m)</label><input type="number" class="m-inp" id="m-h" value="2.70" onchange="App.calcMetrics()"></div>
            <div class="m-box" style="flex:0.8;"><label>Surface(m²)</label><div class="m-res" id="m-surf">0</div></div>
        </div>
    </main>

    <main id="view-menu" class="view-section">
        <header class="mobile-header"><h3>Menu Entreprise</h3></header>
        <div style="padding:20px;">
            <div class="card" onclick="App.generatePDF()">
                <div style="display:flex; align-items:center; gap:15px;">
                    <i class="fas fa-file-pdf" style="font-size:1.5rem; color:var(--c-danger);"></i>
                    <b>Générer PDF Devis</b>
                </div>
            </div>
            <div class="card">
                <b>Mon Entreprise</b>
                <div class="text-muted" style="margin-top:5px;">Configurateur données société</div>
            </div>
            <button onclick="location.reload()" style="width:100%; padding:15px; margin-top:30px; background:white; border:1px solid var(--c-danger); color:var(--c-danger); font-weight:700; border-radius:8px;">DECONNEXION</button>
        </div>
    </main>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="App.nav('home')" id="nav-home"><i class="fas fa-home"></i>Accueil</button>
        <button class="nav-btn" onclick="App.nav('clients')" id="nav-clients"><i class="fas fa-users"></i>Clients</button>
        <button class="nav-btn" onclick="App.nav('devis')" id="nav-devis"><i class="fas fa-calculator"></i>Devis</button>
        <button class="nav-btn" onclick="App.nav('menu')" id="nav-menu"><i class="fas fa-bars"></i>Menu</button>
    </nav>

    <div id="modal-chantier" class="full-modal">
        <div class="modal-header">
            <h3>Nouveau Chantier</h3>
            <button class="btn-close" onclick="App.closeModal('modal-chantier')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-section-title">1. CLIENT</div>
            <div class="input-group">
                <label class="input-label">Sélectionner Client</label>
                <select id="proj-client-select" class="app-input" onchange="App.handleClientSelect(this.value)">
                    <option value="">-- Choisir --</option>
                    <option value="new">+ Créer Nouveau Client</option>
                </select>
            </div>
            
            <div id="quick-client-form" style="display:none; background:#EFF6FF; padding:10px 0; border-top:1px solid #DBEAFE; border-bottom:1px solid #DBEAFE;">
                <div class="type-switch mb-2">
                    <div class="switch-opt active" id="qc-phys" onclick="App.toggleQC('phys')">Particulier</div>
                    <div class="switch-opt" id="qc-mor" onclick="App.toggleQC('mor')">Entreprise</div>
                </div>
                <div class="input-group"><label class="input-label">Nom / Raison Sociale</label><input type="text" id="qc-name" class="app-input"></div>
                <div class="input-group"><label class="input-label">Email</label><input type="email" id="qc-email" class="app-input"></div>
                <div class="input-group"><label class="input-label">Adresse</label><input type="text" id="qc-addr" class="app-input"></div>
            </div>

            <div class="form-section-title">2. INFOS CHANTIER</div>
            <div class="input-group"><label class="input-label">Nom du Projet (Ref)</label><input type="text" id="proj-name" class="app-input" placeholder="Ex: Rénov Cuisine"></div>
            <div class="input-group"><label class="input-label">Adresse Travaux</label><input type="text" id="proj-addr" class="app-input"></div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:0 15px;">
                <div><label class="input-label">Bâtiment</label><input type="text" id="proj-bat" class="app-input"></div>
                <div><label class="input-label">Etage</label><input type="text" id="proj-etage" class="app-input"></div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:0 15px; margin-top:10px;">
                <div><label class="input-label">Digicode</label><input type="text" id="proj-code" class="app-input"></div>
                <div><label class="input-label">Ascenseur</label>
                    <select id="proj-asc" class="app-input">
                        <option value="Oui">Oui</option>
                        <option value="Non">Non</option>
                    </select>
                </div>
            </div>

            <div class="form-section-title">3. TECHNIQUE & ACCES</div>
            <div class="input-group"><label class="input-label">Gardien / Contact</label><input type="text" id="proj-gardien" class="app-input"></div>
            <div class="input-group"><label class="input-label">Syndic (Nom/Tel)</label><input type="text" id="proj-syndic" class="app-input"></div>
            <div class="input-group"><label class="input-label">Plombier Immeuble</label><input type="text" id="proj-plombier" class="app-input"></div>
            <div class="input-group"><label class="input-label">Emplacement Coupure Eau</label><input type="text" id="proj-eau" class="app-input"></div>
            <div class="input-group"><label class="input-label">Chauffage</label>
                <select id="proj-chauffage" class="app-input">
                    <option value="Individuel">Individuel</option>
                    <option value="Collectif">Collectif</option>
                </select>
            </div>

            <div style="height:20px;"></div>
            <div style="padding:15px;"><button class="btn-save" style="border-radius:8px;" onclick="App.createChantier()">CREER LE CHANTIER</button></div>
        </div>
    </div>

    <div id="modal-client" class="full-modal">
        <div class="modal-header">
            <h3>Fiche Client</h3>
            <button class="btn-close" onclick="App.closeModal('modal-client')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="cli-id">
            <div style="padding:15px 15px 0 15px;">
                <div class="type-switch">
                    <div class="switch-opt active" id="cli-type-phys" onclick="App.setClientType('physique')">Physique</div>
                    <div class="switch-opt" id="cli-type-mor" onclick="App.setClientType('morale')">Morale</div>
                </div>
            </div>

            <div class="form-section-title">COORDONNEES</div>
            <div class="input-group"><label class="input-label">Email</label><input type="email" id="cli-email" class="app-input"></div>
            <div class="input-group"><label class="input-label">Téléphone</label><input type="tel" id="cli-phone" class="app-input"></div>
            <div class="input-group"><label class="input-label">Adresse Facturation</label><input type="text" id="cli-addr" class="app-input"></div>

            <div id="fields-phys">
                <div class="form-section-title">IDENTITE</div>
                <div style="display:grid; grid-template-columns:80px 1fr; gap:10px; padding:0 15px;">
                    <div><label class="input-label">Civilité</label>
                        <select id="cli-civ" class="app-input"><option>M.</option><option>Mme</option></select>
                    </div>
                    <div><label class="input-label">Nom</label><input type="text" id="cli-nom" class="app-input"></div>
                </div>
                <div class="input-group mt-2"><label class="input-label">Prénom</label><input type="text" id="cli-prenom" class="app-input"></div>
            </div>

            <div id="fields-mor" style="display:none;">
                <div class="form-section-title">ENTREPRISE</div>
                <div class="input-group"><label class="input-label">Raison Sociale</label><input type="text" id="cli-soc" class="app-input"></div>
                <div class="input-group"><label class="input-label">SIRET</label><input type="text" id="cli-siret" class="app-input"></div>
                <div class="input-group"><label class="input-label">TVA Intra</label><input type="text" id="cli-tva" class="app-input"></div>
                <div class="input-group"><label class="input-label">Contact (Référent)</label><input type="text" id="cli-ref" class="app-input"></div>
            </div>

            <div style="padding:15px; margin-top:20px;">
                <button class="btn-save" style="border-radius:8px;" onclick="App.saveClient()">ENREGISTRER</button>
            </div>
            
            <div style="padding:0 15px;">
                <button onclick="App.createChantierForClient()" style="width:100%; padding:15px; background:#ECFDF5; color:#065F46; border:1px solid #10B981; border-radius:8px; font-weight:700;">+ CREER CHANTIER POUR CE CLIENT</button>
            </div>
        </div>
    </div>

    <div id="modal-item" class="full-modal">
        <div class="modal-header">
            <h3>Détail Ouvrage</h3>
            <button class="btn-close" onclick="App.closeModal('modal-item')">&times;</button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="item-id">
            <div class="input-group mt-2">
                <label class="input-label">Désignation</label>
                <textarea id="item-desc" class="app-input" style="height:80px;"></textarea>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:0 15px;">
                <div><label class="input-label">Quantité</label><input type="number" id="item-qty" class="app-input" style="font-weight:bold; font-size:1.2rem;"></div>
                <div><label class="input-label">Unité</label>
                    <select id="item-unit" class="app-input"><option>m²</option><option>ml</option><option>U</option><option>Ens</option></select>
                </div>
            </div>

            <div style="background:#EFF6FF; margin:15px; padding:15px; border-radius:8px; border:1px solid #DBEAFE;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div><label class="input-label text-navy">Prix Unit. (€)</label><input type="number" id="item-price" class="app-input text-navy" style="font-weight:900;"></div>
                    <div><label class="input-label">TVA</label>
                        <select id="item-tva" class="app-input"><option value="0.1">10%</option><option value="0.2">20%</option><option value="0.055">5.5%</option></select>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label class="input-label">Notes Internes</label>
                <input type="text" id="item-note" class="app-input">
            </div>

            <div style="padding:15px; display:flex; gap:10px;">
                <button onclick="App.deleteItem()" style="flex:1; background:white; color:var(--c-danger); border:1px solid var(--c-danger); border-radius:8px;">SUPPRIMER</button>
                <button onclick="App.saveItem()" style="flex:2; background:var(--c-navy); color:white; border:none; border-radius:8px; height:50px; font-weight:700;">VALIDER</button>
            </div>
        </div>
    </div>

    <div id="modal-library" class="full-modal">
        <div class="modal-header">
            <h3>Bibliothèque</h3>
            <button class="btn-close" onclick="App.closeModal('modal-library')">&times;</button>
        </div>
        <div class="modal-body" style="padding:0;" id="lib-container">
            </div>
    </div>

    <script>
        // --- 1. CONFIGURAZIONE & DATI ---
        const Config = {
            LIBRARY: {
                'INSTALLATION': ['Protection sol', 'Echafaudage', 'Benne'],
                'DEMOLITION': ['Dépose sol', 'Démolition cloison', 'Dépose sanitaire', 'Evacuation'],
                'PLATRERIE': ['Cloison BA13', 'Doublage', 'Faux-plafond', 'Enduit'],
                'PEINTURE': ['Impression', 'Peinture Murs', 'Peinture Plafonds', 'Laque Portes'],
                'SOLS': ['Ragréage', 'Carrelage', 'Parquet Flottant', 'Plinthes'],
                'PLOMBERIE': ['WC Suspendu', 'Douche Italienne', 'Meuble Vasque', 'Chauffe-eau'],
                'ELECTRICITE': ['Prise', 'Interrupteur', 'Tableau Elec', 'Spots']
            }
        };

        const Store = {
            data: {
                clients: [], // [{id, type, name, addr...}]
                chantiers: [], // [{id, clientId, name, addr, details:{...}, activeRoom, rooms:[], items:[], metrics:{}}]
                activeChantierId: null
            },
            init() {
                const s = localStorage.getItem('qotia_mobile_v3');
                if(s) this.data = JSON.parse(s);
            },
            save() {
                localStorage.setItem('qotia_mobile_v3', JSON.stringify(this.data));
            }
        };

        // --- 2. CONTROLLER APP ---
        const App = {
            init() {
                Store.init();
                if(localStorage.getItem('qotia_user')) document.getElementById('login-view').style.display='none';
                this.renderHome();
            },

            login() {
                localStorage.setItem('qotia_user', 'true');
                document.getElementById('login-view').style.display='none';
            },

            nav(view) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById('view-'+view).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
                document.getElementById('nav-'+view).classList.add('active');

                if(view === 'devis') this.renderDevis();
                if(view === 'clients') this.renderClients();
            },

            // --- GESTIONE CLIENTI ---
            renderClients(filter = "") {
                const cList = document.getElementById('clients-list-container');
                cList.innerHTML = "";
                const term = filter.toLowerCase();
                
                Store.data.clients.forEach(c => {
                    let displayName = c.type === 'morale' ? c.company : `${c.nom} ${c.prenom}`;
                    if(displayName.toLowerCase().includes(term)) {
                        const div = document.createElement('div');
                        div.className = 'card';
                        div.style.borderLeftColor = c.type === 'morale' ? '#4B5563' : '#1E3A8A';
                        div.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <div style="font-weight:700; color:#111827;">${displayName}</div>
                                    <div class="text-muted"><i class="fas fa-map-marker-alt"></i> ${c.addr || '-'}</div>
                                    <div style="font-size:0.8rem; color:#059669;">${c.email || ''}</div>
                                </div>
                                <button onclick="App.editClient(${c.id})" style="background:#F3F4F6; border:none; width:40px; height:40px; border-radius:50%;"><i class="fas fa-pen"></i></button>
                            </div>
                        `;
                        cList.appendChild(div);
                    }
                });
            },

            openClientModal() {
                this.resetClientForm();
                document.getElementById('modal-client').classList.add('open');
            },
            
            resetClientForm() {
                document.getElementById('cli-id').value = '';
                ['cli-email','cli-phone','cli-addr','cli-nom','cli-prenom','cli-soc','cli-siret','cli-tva','cli-ref'].forEach(id => document.getElementById(id).value='');
                this.setClientType('physique');
            },

            setClientType(type) {
                const isMor = type === 'morale';
                document.getElementById('cli-type-phys').className = `switch-opt ${!isMor?'active':''}`;
                document.getElementById('cli-type-mor').className = `switch-opt ${isMor?'active':''}`;
                document.getElementById('fields-phys').style.display = isMor ? 'none' : 'block';
                document.getElementById('fields-mor').style.display = isMor ? 'block' : 'none';
            },

            saveClient() {
                const id = document.getElementById('cli-id').value;
                const isMor = document.getElementById('cli-type-mor').classList.contains('active');
                
                const client = {
                    id: id ? parseInt(id) : Date.now(),
                    type: isMor ? 'morale' : 'physique',
                    email: document.getElementById('cli-email').value,
                    phone: document.getElementById('cli-phone').value,
                    addr: document.getElementById('cli-addr').value,
                    // Phys
                    civ: document.getElementById('cli-civ').value,
                    nom: document.getElementById('cli-nom').value,
                    prenom: document.getElementById('cli-prenom').value,
                    // Mor
                    company: document.getElementById('cli-soc').value,
                    siret: document.getElementById('cli-siret').value,
                    tva: document.getElementById('cli-tva').value,
                    ref: document.getElementById('cli-ref').value
                };

                if(id) {
                    const idx = Store.data.clients.findIndex(x => x.id == id);
                    Store.data.clients[idx] = client;
                } else {
                    Store.data.clients.push(client);
                }
                Store.save();
                this.renderClients();
                
                // Return ID for chain actions
                return client.id;
            },

            editClient(id) {
                const c = Store.data.clients.find(x => x.id == id);
                if(!c) return;
                document.getElementById('cli-id').value = c.id;
                document.getElementById('cli-email').value = c.email;
                document.getElementById('cli-phone').value = c.phone;
                document.getElementById('cli-addr').value = c.addr;
                
                this.setClientType(c.type);
                if(c.type === 'physique') {
                    document.getElementById('cli-civ').value = c.civ;
                    document.getElementById('cli-nom').value = c.nom;
                    document.getElementById('cli-prenom').value = c.prenom;
                } else {
                    document.getElementById('cli-soc').value = c.company;
                    document.getElementById('cli-siret').value = c.siret;
                    document.getElementById('cli-tva').value = c.tva;
                    document.getElementById('cli-ref').value = c.ref;
                }
                document.getElementById('modal-client').classList.add('open');
            },

            createChantierForClient() {
                // Salva prima
                const cliId = this.saveClient();
                document.getElementById('modal-client').classList.remove('open');
                this.openProjectWizard(cliId);
            },

            // --- GESTIONE CHANTIER (Progetto) ---
            openProjectWizard(preselectedClientId = null) {
                // Reset Fields
                ['proj-name','proj-addr','proj-bat','proj-etage','proj-code','proj-gardien','proj-syndic','proj-plombier','proj-eau','qc-name','qc-email','qc-addr'].forEach(id => document.getElementById(id).value = '');
                
                // Populate Client Select
                const sel = document.getElementById('proj-client-select');
                sel.innerHTML = '<option value="">-- Choisir --</option><option value="new">+ Créer Nouveau Client</option>';
                Store.data.clients.forEach(c => {
                    let n = c.type === 'morale' ? c.company : `${c.nom} ${c.prenom}`;
                    let opt = document.createElement('option');
                    opt.value = c.id; opt.text = n;
                    sel.appendChild(opt);
                });

                if(preselectedClientId) sel.value = preselectedClientId;
                
                document.getElementById('modal-chantier').classList.add('open');
            },

            handleClientSelect(val) {
                document.getElementById('quick-client-form').style.display = (val === 'new') ? 'block' : 'none';
            },
            
            toggleQC(type) {
                document.getElementById('qc-phys').className = `switch-opt ${type=='phys'?'active':''}`;
                document.getElementById('qc-mor').className = `switch-opt ${type=='mor'?'active':''}`;
            },

            createChantier() {
                let cliId = document.getElementById('proj-client-select').value;
                if(cliId === 'new') {
                    // Create minimal client logic
                    const newC = {
                        id: Date.now(),
                        type: document.getElementById('qc-mor').classList.contains('active') ? 'morale' : 'physique',
                        company: document.getElementById('qc-name').value, // Use name field generic
                        nom: document.getElementById('qc-name').value,
                        email: document.getElementById('qc-email').value,
                        addr: document.getElementById('qc-addr').value,
                        prenom:''
                    };
                    Store.data.clients.push(newC);
                    cliId = newC.id;
                }

                if(!cliId) return alert("Sélectionnez un client !");

                const chantier = {
                    id: Date.now(),
                    clientId: parseInt(cliId),
                    name: document.getElementById('proj-name').value || 'Nouveau Chantier',
                    addr: document.getElementById('proj-addr').value,
                    details: {
                        bat: document.getElementById('proj-bat').value,
                        etage: document.getElementById('proj-etage').value,
                        code: document.getElementById('proj-code').value,
                        asc: document.getElementById('proj-asc').value,
                        gardien: document.getElementById('proj-gardien').value,
                        syndic: document.getElementById('proj-syndic').value,
                        plombier: document.getElementById('proj-plombier').value,
                        eau: document.getElementById('proj-eau').value,
                        chauffage: document.getElementById('proj-chauffage').value
                    },
                    rooms: ['Cuisine'],
                    activeRoom: 'Cuisine',
                    metrics: { 'Cuisine': {L:0, l:0, h:2.7}},
                    items: [],
                    total: 0
                };

                Store.data.chantiers.unshift(chantier);
                Store.data.activeChantierId = chantier.id;
                Store.save();
                
                document.getElementById('modal-chantier').classList.remove('open');
                this.nav('devis');
            },

            // --- EDITOR DEVIS (Logica Completa) ---
            getActiveChantier() {
                return Store.data.chantiers.find(c => c.id == Store.data.activeChantierId);
            },

            renderDevis() {
                const ch = this.getActiveChantier();
                if(!ch) {
                    document.getElementById('devis-items-list').innerHTML = '<div style="text-align:center; padding:30px; color:#999;">Aucun chantier actif. Créez-en un.</div>';
                    return;
                }

                // Header Info
                const cli = Store.data.clients.find(c => c.id == ch.clientId);
                document.getElementById('devis-client-name').innerText = cli ? (cli.type=='morale'?cli.company:`${cli.nom} ${cli.prenom}`) : 'Client Inconnu';
                document.getElementById('devis-chantier-name').innerText = ch.name;

                // Room Tabs
                const tabs = document.getElementById('room-tabs');
                tabs.innerHTML = '';
                ch.rooms.forEach(r => {
                    const pill = document.createElement('div');
                    pill.className = `room-pill ${r===ch.activeRoom ? 'active' : ''}`;
                    pill.innerText = r;
                    pill.onclick = () => { ch.activeRoom = r; Store.save(); this.renderDevis(); };
                    tabs.appendChild(pill);
                });
                // Add Room
                const addR = document.createElement('div');
                addR.innerHTML = '<i class="fas fa-plus"></i>';
                addR.className = 'room-pill';
                addR.onclick = () => {
                    const n = prompt("Nom de la pièce ?");
                    if(n) {
                        ch.rooms.push(n);
                        ch.metrics[n] = {L:0, l:0, h:2.7};
                        ch.activeRoom = n;
                        Store.save(); this.renderDevis();
                    }
                };
                tabs.appendChild(addR);

                // Load Metrics
                const m = ch.metrics[ch.activeRoom] || {L:0, l:0, h:2.7};
                document.getElementById('m-L').value = m.L;
                document.getElementById('m-l').value = m.l;
                document.getElementById('m-h').value = m.h;
                this.calcMetrics(false);

                // Render Items
                const list = document.getElementById('devis-items-list');
                list.innerHTML = '';
                let gTotal = 0;
                
                // Filter items by room
                const roomItems = ch.items.filter(i => i.room === ch.activeRoom);
                
                roomItems.forEach(item => {
                    const tot = item.qty * item.price;
                    const div = document.createElement('div');
                    div.className = 'ouvr-card';
                    div.innerHTML = `
                        <div style="flex:1">
                            <div class="ouvr-fam">${item.fam || 'Divers'}</div>
                            <div class="ouvr-desc">${item.desc}</div>
                            <div class="ouvr-meta">${item.qty} ${item.unit} x ${item.price}€</div>
                        </div>
                        <div class="ouvr-price">${tot.toFixed(0)}€</div>
                    `;
                    div.onclick = () => this.editItem(item.id);
                    list.appendChild(div);
                });

                // Global Total
                ch.items.forEach(i => gTotal += (i.qty * i.price));
                document.getElementById('devis-total').innerText = gTotal.toFixed(0) + ' €';
                
                // KPI Update
                document.getElementById('kpi-revenue').innerText = gTotal.toFixed(0) + ' €';
            },

            calcMetrics(save = true) {
                const L = parseFloat(document.getElementById('m-L').value)||0;
                const l = parseFloat(document.getElementById('m-l').value)||0;
                const h = parseFloat(document.getElementById('m-h').value)||0;
                document.getElementById('m-surf').innerText = (L*l).toFixed(2);
                
                if(save) {
                    const ch = this.getActiveChantier();
                    if(ch) {
                        ch.metrics[ch.activeRoom] = {L, l, h};
                        Store.save();
                    }
                }
            },

            // --- LIBRARY & ITEMS ---
            openLibrary() {
                const cont = document.getElementById('lib-container');
                cont.innerHTML = '';
                
                for(const [fam, items] of Object.entries(Config.LIBRARY)) {
                    const head = document.createElement('div');
                    head.style.background = '#F3F4F6'; head.style.padding='10px 15px'; head.style.fontWeight='700'; head.style.color='#1E3A8A';
                    head.innerText = fam;
                    cont.appendChild(head);
                    
                    items.forEach(it => {
                        const row = document.createElement('div');
                        row.style.padding='15px'; row.style.borderBottom='1px solid #eee'; row.style.background='white';
                        row.innerText = it;
                        row.onclick = () => this.addItem(fam, it);
                        cont.appendChild(row);
                    });
                }
                document.getElementById('modal-library').classList.add('open');
            },

            addItem(fam, desc) {
                const ch = this.getActiveChantier();
                const m = ch.metrics[ch.activeRoom];
                // Auto qty logic simplified
                let qty = 1;
                if(fam === 'SOLS' || fam === 'PEINTURE') qty = (m.L * m.l) || 1;

                const item = {
                    id: Date.now(),
                    room: ch.activeRoom,
                    fam: fam,
                    desc: desc,
                    qty: parseFloat(qty.toFixed(2)),
                    unit: 'm²',
                    price: 45, // default
                    tva: 0.1
                };
                ch.items.push(item);
                Store.save();
                this.closeModal('modal-library');
                this.editItem(item.id); // Open edit immediately
            },

            editItem(id) {
                const ch = this.getActiveChantier();
                const item = ch.items.find(i => i.id == id);
                if(!item) return;
                
                document.getElementById('item-id').value = item.id;
                document.getElementById('item-desc').value = item.desc;
                document.getElementById('item-qty').value = item.qty;
                document.getElementById('item-unit').value = item.unit;
                document.getElementById('item-price').value = item.price;
                document.getElementById('item-tva').value = item.tva;
                document.getElementById('item-note').value = item.note || '';
                
                document.getElementById('modal-item').classList.add('open');
            },

            saveItem() {
                const id = document.getElementById('item-id').value;
                const ch = this.getActiveChantier();
                const item = ch.items.find(i => i.id == id);
                if(item) {
                    item.desc = document.getElementById('item-desc').value;
                    item.qty = parseFloat(document.getElementById('item-qty').value);
                    item.unit = document.getElementById('item-unit').value;
                    item.price = parseFloat(document.getElementById('item-price').value);
                    item.tva = parseFloat(document.getElementById('item-tva').value);
                    item.note = document.getElementById('item-note').value;
                    Store.save();
                    this.renderDevis();
                    this.closeModal('modal-item');
                }
            },

            deleteItem() {
                if(confirm('Supprimer cet ouvrage ?')) {
                    const id = document.getElementById('item-id').value;
                    const ch = this.getActiveChantier();
                    ch.items = ch.items.filter(i => i.id != id);
                    Store.save();
                    this.renderDevis();
                    this.closeModal('modal-item');
                }
            },

            // --- UTILS ---
            openChantierDetails() {
                const ch = this.getActiveChantier();
                if(!ch) return;
                let det = ch.details;
                let info = `Code: ${det.code}\nEtage: ${det.etage}\nGardien: ${det.gardien}\nPlombier: ${det.plombier}\nChauffage: ${det.chauffage}\nEau: ${det.eau}`;
                alert(info);
            },
            
            closeModal(id) { document.getElementById(id).classList.remove('open'); },
            
            renderHome() {
                const list = document.getElementById('home-recent-list');
                list.innerHTML = '';
                Store.data.chantiers.slice(0,5).forEach(c => {
                    let cli = Store.data.clients.find(x => x.id == c.clientId);
                    let cliName = cli ? (cli.type=='morale'?cli.company:cli.nom) : 'Unknown';
                    const d = document.createElement('div');
                    d.className = 'card';
                    d.innerHTML = `
                        <div style="font-weight:700;">${c.name}</div>
                        <div class="text-muted" style="font-size:0.8rem;">${cliName}</div>
                    `;
                    d.onclick = () => { Store.data.activeChantierId = c.id; Store.save(); this.nav('devis'); };
                    list.appendChild(d);
                });
            },

            generatePDF() {
                alert("Génération PDF en cours... (Simulé)");
            }
        };

        // START
        window.onload = () => App.init();

    </script>
</body>
</html>
