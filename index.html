<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1E3A8A">
    <meta name="description" content="QOTIA Mobile AI - Gestion BTP">
    <title>QOTIA Mobile AI</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- SYSTEM DESIGN "RUGGED" --- */
        :root {
            --c-yellow: #FCD34D;
            --c-navy: #1E3A8A;
            --c-dark: #111827;
            --c-grey: #F3F4F6;
            --c-white: #FFFFFF;
            --c-ai: #8B5CF6; /* Viola per AI */
            
            --h-nav: 65px;
            --h-input: 50px;
            --radius: 8px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; padding: 0; font-family: 'Roboto', sans-serif; 
            background-color: var(--c-grey); color: var(--c-dark);
            font-size: 16px; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- LAYOUT --- */
        .view-section {
            display: none; flex-direction: column; height: 100%; width: 100%;
            overflow-y: auto; padding-bottom: calc(var(--h-nav) + 20px); background: var(--c-grey);
        }
        .view-section.active { display: flex; }
        #view-devis { padding-bottom: 140px; }

        /* --- HEADER & NAV --- */
        .mobile-header {
            flex: 0 0 60px; background: var(--c-white); border-bottom: 2px solid var(--c-yellow);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 100;
        }
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--h-nav);
            background: var(--c-white); border-top: 1px solid #E5E7EB;
            display: grid; grid-template-columns: repeat(4, 1fr); z-index: 1000;
        }
        .nav-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #9CA3AF; font-size: 0.7rem; border: none; background: transparent; font-weight: 600;
        }
        .nav-btn i { font-size: 1.4rem; margin-bottom: 4px; }
        .nav-btn.active { color: var(--c-navy); background: #EFF6FF; }

        /* --- CARDS & UI --- */
        .card {
            background: var(--c-white); border-radius: var(--radius); padding: 15px; margin: 10px 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid var(--c-navy);
        }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px 15px; }
        .big-btn {
            background: var(--c-white); border: 2px solid #E5E7EB; border-radius: var(--radius);
            padding: 20px 10px; display: flex; flex-direction: column; align-items: center;
            font-weight: 700; color: var(--c-navy);
        }
        /* AI Button Special Style */
        .btn-ai-header {
            background: linear-gradient(135deg, #8B5CF6, #6366F1); color: white; border: none;
            padding: 5px 12px; border-radius: 20px; font-weight: 700; font-size: 0.8rem;
            display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(139, 92, 246, 0.4);
        }
        .btn-ai-float {
            position: fixed; bottom: calc(var(--h-nav) + 145px); right: 20px;
            width: 50px; height: 50px; border-radius: 50%;
            background: linear-gradient(135deg, #8B5CF6, #6366F1); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 950; border: 2px solid white;
        }

        /* --- FORMS --- */
        .input-group { margin-bottom: 12px; padding: 0 15px; }
        .input-label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--c-navy); margin-bottom: 4px; text-transform: uppercase; }
        .app-input {
            width: 100%; height: var(--h-input); border: 1px solid #D1D5DB; border-radius: 6px;
            padding: 0 10px; font-size: 1rem; background: #fff;
        }
        .type-switch { display: flex; margin: 0 15px; background: #E5E7EB; border-radius: 8px; padding: 4px; }
        .switch-opt { flex: 1; text-align: center; padding: 8px; font-weight: 600; border-radius: 6px; font-size: 0.9rem; color: #666; }
        .switch-opt.active { background: white; color: var(--c-navy); }

        /* --- DEVIS SPECIFIC --- */
        .room-scroll-nav {
            flex: 0 0 50px; background: var(--c-navy); display: flex; overflow-x: auto; align-items: center; padding: 0 10px; gap: 8px;
        }
        .room-pill { background: rgba(255,255,255,0.2); color: white; padding: 6px 14px; border-radius: 20px; white-space: nowrap; font-size: 0.9rem; }
        .room-pill.active { background: var(--c-yellow); color: var(--c-dark); font-weight: 700; }
        
        .measures-footer {
            position: fixed; bottom: var(--h-nav); left: 0; width: 100%; height: 60px;
            background: var(--c-dark); display: flex; align-items: center; padding: 5px; gap: 5px;
            z-index: 900; border-top: 3px solid var(--c-yellow);
        }
        .m-inp { width: 100%; background: #374151; border: 1px solid #4B5563; color: white; text-align: center; font-weight: bold; border-radius: 4px; height: 35px; font-size: 1rem; }
        .m-res { color: var(--c-yellow); text-align: center; font-weight: 900; font-size: 1.1rem; line-height: 35px; }

        .fab-add {
            position: fixed; bottom: calc(var(--h-nav) + 75px); right: 20px;
            width: 60px; height: 60px; border-radius: 50%; background: var(--c-navy); color: white;
            display: flex; align-items: center; justify-content: center; font-size: 1.8rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 950; border: 2px solid white;
        }

        /* --- MODALS --- */
        .full-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--c-grey); z-index: 2000; display: none; flex-direction: column; overflow-y: auto;
        }
        .full-modal.open { display: flex; }
        .modal-header {
            flex: 0 0 60px; background: white; border-bottom: 1px solid #ddd;
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
        }
        .btn-save { width: 100%; height: 50px; background: var(--c-navy); color: white; font-weight: 700; border: none; font-size: 1rem; }
        
        .ai-overlay {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white; 
            z-index: 3000; border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 20px; box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
            transform: translateY(100%); transition: transform 0.3s ease;
        }
        .ai-overlay.active { transform: translateY(0); }

        .ouvr-card {
            background: white; padding: 12px; margin: 8px 10px; border-radius: 8px; border: 1px solid #E5E7EB; border-left: 4px solid var(--c-yellow); display: flex; justify-content: space-between; align-items: center;
        }
    </style>
</head>
<body>

    <div id="login-view" style="position:fixed; inset:0; background:var(--c-navy); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px;">
        <div style="width:80px; height:80px; background:var(--c-yellow); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:40px; font-weight:900; color:var(--c-navy); margin-bottom:20px;">Q</div>
        <h1 style="color:white; margin-bottom:10px;">QOTIA Mobile</h1>
        <div style="color:#CBD5E1; margin-bottom:40px;">COLLABORATEUR</div>
        <div style="background:white; padding:20px; border-radius:12px; width:100%; max-width:350px;">
            <button class="btn-save" style="border-radius:6px;" onclick="App.login()">CONNEXION</button>
        </div>
    </div>

    <main id="view-home" class="view-section">
        <header class="mobile-header">
            <div style="font-weight:900; font-size:1.2rem; color:var(--c-navy);">QOTIA</div>
            <button class="btn-ai-header" onclick="AI.openPrompt('project')"><i class="fas fa-magic"></i> Assistant IA</button>
        </header>

        <div class="action-grid">
            <div class="big-btn" onclick="App.openProjectWizard()"><i class="fas fa-folder-plus"></i><span>Nouveau<br>Chantier</span></div>
            <div class="big-btn" onclick="App.openClientModal()"><i class="fas fa-user-plus"></i><span>Nouveau<br>Client</span></div>
        </div>

        <div style="padding: 0 15px;">
            <div class="card" style="margin:0 0 15px 0; background:#FFFBEB; border-color:var(--c-yellow);">
                <div style="font-size:0.75rem; text-transform:uppercase; color:#92400E; font-weight:700;">CA Accept√© (Mois)</div>
                <div style="font-size:1.8rem; font-weight:900; color:#B45309;" id="kpi-revenue">0 ‚Ç¨</div>
            </div>
            <h3 style="margin: 10px 0; color:var(--c-navy);">Devis R√©cents</h3>
            <div id="home-recent-list"></div>
        </div>
    </main>

    <main id="view-clients" class="view-section">
        <header class="mobile-header"><h3>Clients</h3><button onclick="App.openClientModal()" style="border:none; background:none; font-size:1.5rem; color:var(--c-navy);"><i class="fas fa-plus-circle"></i></button></header>
        <div style="padding:10px 15px; background:white; border-bottom:1px solid #eee;">
            <input type="text" class="app-input" placeholder="Rechercher..." onkeyup="App.renderClients(this.value)">
        </div>
        <div id="clients-list-container"></div>
    </main>

    <main id="view-devis" class="view-section">
        <header class="mobile-header" style="height:auto; flex-direction:column; padding:10px 15px; align-items:stretch;">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <div style="overflow:hidden;">
                    <div style="font-weight:900; font-size:1.1rem; color:var(--c-navy);" id="devis-client-name">...</div>
                    <div style="font-size:0.8rem; color:#666;" id="devis-chantier-name">...</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:900; font-size:1.2rem; color:var(--c-navy);" id="devis-total">0 ‚Ç¨</div>
                    <button onclick="App.openChantierDetails()" style="font-size:0.7rem; background:#EFF6FF; border:1px solid #DBEAFE; padding:2px 6px; border-radius:4px; color:var(--c-navy); font-weight:700;">Info</button>
                </div>
            </div>
        </header>

        <div class="room-scroll-nav" id="room-tabs"></div>
        <div id="devis-items-list" style="padding:10px 0;"></div>

        <button class="btn-ai-float" onclick="AI.openPrompt('items')"><i class="fas fa-magic"></i></button>
        <button class="fab-add" onclick="App.openLibrary()"><i class="fas fa-plus"></i></button>

        <div class="measures-footer">
            <div class="m-box"><label>L(m)</label><input type="number" class="m-inp" id="m-L" onchange="App.calcMetrics()"></div>
            <div class="m-box"><label>l(m)</label><input type="number" class="m-inp" id="m-l" onchange="App.calcMetrics()"></div>
            <div class="m-box"><label>H(m)</label><input type="number" class="m-inp" id="m-h" value="2.70" onchange="App.calcMetrics()"></div>
            <div class="m-box" style="flex:0.8;"><label>M¬≤</label><div class="m-res" id="m-surf">0</div></div>
        </div>
    </main>

    <main id="view-menu" class="view-section">
        <header class="mobile-header"><h3>Menu Entreprise</h3></header>
        <div style="padding:20px;">
            <div class="card" onclick="alert('PDF G√©n√©r√©')"><b><i class="fas fa-file-pdf"></i> PDF Devis</b></div>
            <button onclick="location.reload()" style="width:100%; padding:15px; margin-top:30px; border:1px solid var(--c-danger); background:white; color:var(--c-danger); font-weight:700; border-radius:8px;">DECONNEXION</button>
        </div>
    </main>

    <nav class="bottom-nav">
        <button class="nav-btn active" onclick="App.nav('home')" id="nav-home"><i class="fas fa-home"></i>Accueil</button>
        <button class="nav-btn" onclick="App.nav('clients')" id="nav-clients"><i class="fas fa-users"></i>Clients</button>
        <button class="nav-btn" onclick="App.nav('devis')" id="nav-devis"><i class="fas fa-calculator"></i>Devis</button>
        <button class="nav-btn" onclick="App.nav('menu')" id="nav-menu"><i class="fas fa-bars"></i>Menu</button>
    </nav>

    <div id="ai-overlay" class="ai-overlay">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="color:var(--c-ai);"><i class="fas fa-magic"></i> Assistant IA</h3>
            <button onclick="AI.close()" style="border:none; background:none; font-size:1.2rem;">&times;</button>
        </div>
        <p id="ai-help-text" style="font-size:0.9rem; color:#666; margin-bottom:10px;">D√©crivez votre projet...</p>
        <textarea id="ai-input" class="app-input" style="height:100px; padding:10px; margin-bottom:15px;" placeholder="Es: R√©novation cuisine pour M. Dupont √† Paris..."></textarea>
        <button class="btn-save" style="background:var(--c-ai);" onclick="AI.process()">EXECUTER</button>
    </div>

    <div id="modal-chantier" class="full-modal">
        <div class="modal-header"><h3>Nouveau Chantier</h3><button class="btn-close" onclick="App.closeModal('modal-chantier')">&times;</button></div>
        <div class="modal-body">
            <div class="form-section-title">1. CLIENT</div>
            <div class="input-group">
                <select id="proj-client-select" class="app-input" onchange="App.handleClientSelect(this.value)">
                    <option value="">-- Choisir --</option><option value="new">+ Cr√©er Nouveau</option>
                </select>
            </div>
            <div id="quick-client-form" style="display:none; background:#EFF6FF; padding:10px 0;">
                <div class="type-switch mb-2"><div class="switch-opt active" id="qc-phys" onclick="App.toggleQC('phys')">Particulier</div><div class="switch-opt" id="qc-mor" onclick="App.toggleQC('mor')">Entreprise</div></div>
                <div class="input-group"><input type="text" id="qc-name" class="app-input" placeholder="Nom"></div>
                <div class="input-group"><input type="text" id="qc-addr" class="app-input" placeholder="Adresse"></div>
            </div>
            <div class="form-section-title">2. INFOS</div>
            <div class="input-group"><input type="text" id="proj-name" class="app-input" placeholder="Nom Projet"></div>
            <div class="input-group"><input type="text" id="proj-addr" class="app-input" placeholder="Adresse Chantier"></div>
            <div class="form-section-title">3. DETAILS</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; padding:0 15px;">
                <input type="text" id="proj-code" class="app-input" placeholder="Code">
                <input type="text" id="proj-etage" class="app-input" placeholder="Etage">
            </div>
            <div class="input-group mt-2"><input type="text" id="proj-syndic" class="app-input" placeholder="Syndic"></div>
            <div style="padding:15px;"><button class="btn-save" style="border-radius:8px;" onclick="App.createChantier()">CREER</button></div>
        </div>
    </div>

    <div id="modal-library" class="full-modal">
        <div class="modal-header"><h3>Biblioth√®que</h3><button class="btn-close" onclick="App.closeModal('modal-library')">&times;</button></div>
        <div class="modal-body" id="lib-container" style="padding:0;"></div>
    </div>

    <div id="modal-client" class="full-modal">
        <div class="modal-header"><h3>Client</h3><button class="btn-close" onclick="App.closeModal('modal-client')">&times;</button></div>
        <div class="modal-body">
            <input type="hidden" id="cli-id">
            <div class="type-switch mt-2"><div class="switch-opt active" id="cli-type-phys" onclick="App.setClientType('physique')">Phys</div><div class="switch-opt" id="cli-type-mor" onclick="App.setClientType('morale')">Morale</div></div>
            <div class="input-group mt-2"><label class="input-label">Nom / Soc.</label><input type="text" id="cli-nom" class="app-input"></div>
            <div class="input-group"><label class="input-label">Email</label><input type="email" id="cli-email" class="app-input"></div>
            <div class="input-group"><label class="input-label">Adresse</label><input type="text" id="cli-addr" class="app-input"></div>
            <div style="padding:15px;"><button class="btn-save" style="border-radius:8px;" onclick="App.saveClient()">SAUVEGARDER</button></div>
        </div>
    </div>

    <script>
        // MOCK AI ENGINE (Simulatore)
        const AI = {
            mode: null, // 'project' or 'items'
            
            openPrompt(mode) {
                this.mode = mode;
                const overlay = document.getElementById('ai-overlay');
                const help = document.getElementById('ai-help-text');
                document.getElementById('ai-input').value = "";
                
                if(mode === 'project') {
                    help.innerText = "Ex: R√©novation SDB pour Marco Rossi √† Nice...";
                } else {
                    help.innerText = "Ex: Peinture murs 40m2 et Pose carrelage 15m2...";
                }
                overlay.classList.add('active');
            },
            
            close() { document.getElementById('ai-overlay').classList.remove('active'); },
            
            process() {
                const text = document.getElementById('ai-input').value;
                if(!text) return;
                
                this.close();
                
                if(this.mode === 'project') {
                    this.simulateProjectCreation(text);
                } else {
                    this.simulateItemAdd(text);
                }
            },
            
            simulateProjectCreation(text) {
                alert("ü§ñ IA Analyse: Cr√©ation Client & Chantier...");
                // Simple parser logic for demo
                const words = text.split(" ");
                const nameIndex = words.findIndex(w => w.toLowerCase() === "pour" || w.toLowerCase() === "per");
                const addrIndex = words.findIndex(w => w.toLowerCase() === "√†" || w.toLowerCase() === "a");
                
                let clientName = "Nouveau Client";
                let projectName = text.substring(0, nameIndex > 0 ? nameIndex : 15);
                let address = "Adresse Inconnue";

                if(nameIndex !== -1) {
                    let end = addrIndex !== -1 ? addrIndex : words.length;
                    clientName = words.slice(nameIndex + 1, end).join(" ");
                }
                if(addrIndex !== -1) {
                    address = words.slice(addrIndex + 1).join(" ");
                }

                // Create Logic
                const newC = {
                    id: Date.now(), type:'physique', nom: clientName, company: clientName, addr: address, email:''
                };
                Store.data.clients.push(newC);
                
                const chantier = {
                    id: Date.now()+1, clientId: newC.id, name: projectName, addr: address,
                    details: {}, rooms:['Cuisine'], activeRoom:'Cuisine', metrics:{'Cuisine':{L:0,l:0,h:2.7}}, items:[]
                };
                Store.data.chantiers.unshift(chantier);
                Store.data.activeChantierId = chantier.id;
                Store.save();
                App.nav('devis');
            },
            
            simulateItemAdd(text) {
                const ch = App.getActiveChantier();
                if(!ch) return alert("Pas de chantier actif");
                
                alert("ü§ñ IA Ajoute les ouvrages...");
                
                // Demo logic: look for numbers
                const parts = text.split(" et "); // Split multiple commands
                parts.forEach(part => {
                    const match = part.match(/(\d+)/);
                    let qty = 1;
                    if(match) qty = parseInt(match[0]);
                    
                    let fam = "DIVERS";
                    if(part.toLowerCase().includes("peinture")) fam = "PEINTURE";
                    if(part.toLowerCase().includes("sol") || part.toLowerCase().includes("carrelage")) fam = "SOLS";
                    if(part.toLowerCase().includes("elec")) fam = "ELECTRICITE";

                    const item = {
                        id: Date.now() + Math.random(),
                        room: ch.activeRoom,
                        fam: fam,
                        desc: part.replace(qty, "").trim() + " (via IA)",
                        qty: qty,
                        unit: 'm¬≤',
                        price: 45,
                        tva: 0.1
                    };
                    ch.items.push(item);
                });
                Store.save();
                App.renderDevis();
            }
        };

        // --- APP LOGIC ---
        const Config = {
            LIBRARY: {
                'INSTALLATION': ['Protection', 'Echafaudage', 'Benne'],
                'DEMOLITION': ['D√©pose sol', 'D√©molition cloison', 'Evacuation'],
                'PLATRERIE': ['Cloison BA13', 'Doublage', 'Enduit'],
                'PEINTURE': ['Impression', 'Peinture Murs', 'Peinture Plafonds'],
                'SOLS': ['Ragr√©age', 'Carrelage', 'Parquet'],
                'ELECTRICITE': ['Prise', 'Interrupteur', 'Tableau']
            }
        };

        const Store = {
            data: { clients: [], chantiers: [], activeChantierId: null },
            init() { const s = localStorage.getItem('qotia_v4'); if(s) this.data = JSON.parse(s); },
            save() { localStorage.setItem('qotia_v4', JSON.stringify(this.data)); }
        };

        const App = {
            init() { Store.init(); if(localStorage.getItem('qotia_logged')) document.getElementById('login-view').style.display='none'; this.renderHome(); },
            login() { localStorage.setItem('qotia_logged','true'); document.getElementById('login-view').style.display='none'; },
            
            nav(view) {
                document.querySelectorAll('.view-section').forEach(e=>e.classList.remove('active'));
                document.getElementById('view-'+view).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
                document.getElementById('nav-'+view).classList.add('active');
                if(view==='devis') this.renderDevis();
                if(view==='clients') this.renderClients();
            },

            // CLIENTS
            renderClients(filter="") {
                const list=document.getElementById('clients-list-container'); list.innerHTML="";
                Store.data.clients.forEach(c=>{
                    let name = c.type==='morale'?c.company:c.nom;
                    if(name.toLowerCase().includes(filter.toLowerCase())){
                        const d=document.createElement('div'); d.className='card';
                        d.innerHTML=`<div style="font-weight:700;">${name}</div><div class="text-muted">${c.addr||''}</div>`;
                        list.appendChild(d);
                    }
                });
            },
            openClientModal() { document.getElementById('modal-client').classList.add('open'); },
            setClientType(t) { 
                const isMor = t==='morale';
                document.getElementById('cli-type-phys').className=`switch-opt ${!isMor?'active':''}`;
                document.getElementById('cli-type-mor').className=`switch-opt ${isMor?'active':''}`;
            },
            saveClient() {
                const c = {
                    id: Date.now(), type: document.getElementById('cli-type-mor').classList.contains('active')?'morale':'physique',
                    nom: document.getElementById('cli-nom').value, company: document.getElementById('cli-nom').value,
                    email: document.getElementById('cli-email').value, addr: document.getElementById('cli-addr').value
                };
                Store.data.clients.push(c); Store.save(); App.closeModal('modal-client'); App.renderClients();
            },

            // CHANTIER
            openProjectWizard() { 
                const sel = document.getElementById('proj-client-select'); sel.innerHTML='<option value="">--</option><option value="new">+ Nouveau</option>';
                Store.data.clients.forEach(c=>{
                    let opt=document.createElement('option'); opt.value=c.id; opt.text=c.type==='morale'?c.company:c.nom; sel.appendChild(opt);
                });
                document.getElementById('modal-chantier').classList.add('open'); 
            },
            handleClientSelect(v) { document.getElementById('quick-client-form').style.display = v==='new'?'block':'none'; },
            toggleQC(t) {
                document.getElementById('qc-phys').className=`switch-opt ${t=='phys'?'active':''}`;
                document.getElementById('qc-mor').className=`switch-opt ${t=='mor'?'active':''}`;
            },
            createChantier() {
                let cliId = document.getElementById('proj-client-select').value;
                if(cliId === 'new') {
                    const nc = { id:Date.now(), type:'physique', nom:document.getElementById('qc-name').value, company:document.getElementById('qc-name').value, addr:document.getElementById('qc-addr').value };
                    Store.data.clients.push(nc); cliId=nc.id;
                }
                if(!cliId) return alert('Client requis');
                const ch = {
                    id: Date.now(), clientId: parseInt(cliId), name: document.getElementById('proj-name').value||'Chantier',
                    addr: document.getElementById('proj-addr').value, 
                    details: { code: document.getElementById('proj-code').value, syndic: document.getElementById('proj-syndic').value },
                    rooms:['Cuisine'], activeRoom:'Cuisine', metrics:{'Cuisine':{L:0,l:0,h:2.7}}, items:[]
                };
                Store.data.chantiers.unshift(ch); Store.data.activeChantierId=ch.id; Store.save();
                App.closeModal('modal-chantier'); App.nav('devis');
            },

            // DEVIS
            getActiveChantier() { return Store.data.chantiers.find(c=>c.id==Store.data.activeChantierId); },
            renderDevis() {
                const ch = this.getActiveChantier();
                if(!ch) return document.getElementById('devis-items-list').innerHTML='<div style="text-align:center;padding:20px;color:#999">Aucun chantier</div>';
                
                const cli = Store.data.clients.find(c=>c.id==ch.clientId);
                document.getElementById('devis-client-name').innerText = cli?(cli.type==='morale'?cli.company:cli.nom):'Client?';
                document.getElementById('devis-chantier-name').innerText = ch.name;

                // Rooms
                const tabs=document.getElementById('room-tabs'); tabs.innerHTML='';
                ch.rooms.forEach(r=>{
                    const p=document.createElement('div'); p.className=`room-pill ${r==ch.activeRoom?'active':''}`; p.innerText=r;
                    p.onclick=()=>{ch.activeRoom=r; Store.save(); App.renderDevis();}; tabs.appendChild(p);
                });
                const add=document.createElement('div'); add.className='room-pill'; add.innerHTML='+'; 
                add.onclick=()=>{const n=prompt('Nom?'); if(n){ch.rooms.push(n); ch.metrics[n]={L:0,l:0,h:2.7}; ch.activeRoom=n; Store.save(); App.renderDevis();}}; tabs.appendChild(add);

                // Metrics
                const m=ch.metrics[ch.activeRoom]||{L:0,l:0,h:2.7};
                document.getElementById('m-L').value=m.L; document.getElementById('m-l').value=m.l; document.getElementById('m-h').value=m.h;
                this.calcMetrics(false);

                // Items
                const list=document.getElementById('devis-items-list'); list.innerHTML='';
                let tot=0;
                ch.items.filter(i=>i.room==ch.activeRoom).forEach(i=>{
                    const t=i.qty*i.price; tot+=t;
                    const d=document.createElement('div'); d.className='ouvr-card';
                    d.innerHTML=`<div><div style="font-size:0.7rem;color:#1E3A8A;font-weight:700;">${i.fam}</div><div style="font-weight:600;">${i.desc}</div><div style="font-size:0.8rem;color:#666;">${i.qty} x ${i.price}‚Ç¨</div></div><div style="font-weight:900;">${t.toFixed(0)}‚Ç¨</div>`;
                    list.appendChild(d);
                });
                
                // Global Total
                let gTot=0; ch.items.forEach(i=>gTot+=i.qty*i.price);
                document.getElementById('devis-total').innerText = gTot.toFixed(0)+'‚Ç¨';
                document.getElementById('kpi-revenue').innerText = gTot.toFixed(0)+'‚Ç¨';
            },
            calcMetrics(save=true) {
                const L=parseFloat(document.getElementById('m-L').value)||0;
                const l=parseFloat(document.getElementById('m-l').value)||0;
                const h=parseFloat(document.getElementById('m-h').value)||0;
                document.getElementById('m-surf').innerText=(L*l).toFixed(2);
                if(save){ const ch=this.getActiveChantier(); if(ch){ ch.metrics[ch.activeRoom]={L,l,h}; Store.save(); }}
            },
            openLibrary() {
                const cont=document.getElementById('lib-container'); cont.innerHTML='';
                for(const [f,its] of Object.entries(Config.LIBRARY)) {
                    const h=document.createElement('div'); h.style='background:#eee;padding:10px;font-weight:bold;color:#1E3A8A'; h.innerText=f; cont.appendChild(h);
                    its.forEach(it=>{
                        const r=document.createElement('div'); r.style='padding:15px;border-bottom:1px solid #ddd'; r.innerText=it;
                        r.onclick=()=>{App.addItem(f,it); App.closeModal('modal-library');}; cont.appendChild(r);
                    });
                }
                document.getElementById('modal-library').classList.add('open');
            },
            addItem(f,d) {
                const ch=this.getActiveChantier(); const m=ch.metrics[ch.activeRoom];
                let qty=1; if(f=='SOLS'||f=='PEINTURE') qty=m.L*m.l;
                ch.items.push({id:Date.now(), room:ch.activeRoom, fam:f, desc:d, qty:parseFloat(qty.toFixed(2)), price:45});
                Store.save(); this.renderDevis();
            },
            
            // UTILS
            openChantierDetails(){ const c=this.getActiveChantier(); if(c) alert(`Code: ${c.details.code}\nSyndic: ${c.details.syndic}`); },
            closeModal(id){document.getElementById(id).classList.remove('open');},
            renderHome(){
                const l=document.getElementById('home-recent-list'); l.innerHTML='';
                Store.data.chantiers.slice(0,5).forEach(c=>{
                    const cli=Store.data.clients.find(x=>x.id==c.clientId);
                    const d=document.createElement('div'); d.className='card';
                    d.innerHTML=`<div style="font-weight:700">${c.name}</div><div class="text-muted">${cli?cli.nom:'?'}</div>`;
                    d.onclick=()=>{Store.data.activeChantierId=c.id;Store.save();App.nav('devis');}; l.appendChild(d);
                });
            }
        };

        window.onload=()=>App.init();
    </script>
</body>
</html>
